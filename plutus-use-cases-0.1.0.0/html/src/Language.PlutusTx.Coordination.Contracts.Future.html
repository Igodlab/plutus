<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds         #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards   #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell   #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-matches #-}</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- | A futures contract in Plutus. This example illustrates three concepts.</span><span>
</span><a name="line-9"></a><span class="hs-comment">--   1. Maintaining a margin (a kind of deposit) during the duration of the contract to protect against breach of contract (see note [Futures in Plutus])</span><span>
</span><a name="line-10"></a><span class="hs-comment">--   2. Using oracle values to obtain current pricing information (see note [Oracles] in Language.PlutusTx.Coordination.Contracts)</span><span>
</span><a name="line-11"></a><span class="hs-comment">--   3. Using the redeemer script to model actions that the participants in the contract may take.</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusTx.Coordination.Contracts.Future</span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- * Data types</span><span>
</span><a name="line-14"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-type">FutureData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureRedeemer"><span class="hs-identifier hs-type">FutureRedeemer</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-comment">-- * Actions</span><span>
</span><a name="line-18"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#initialise"><span class="hs-identifier hs-var">initialise</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#settle"><span class="hs-identifier hs-var">settle</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#settleEarly"><span class="hs-identifier hs-var">settleEarly</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#adjustMargin"><span class="hs-identifier hs-var">adjustMargin</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-comment">-- * Script</span><span>
</span><a name="line-23"></a><span>    </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Error.Class</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeToList</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusTx</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PlutusTx</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ledger</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DataScript</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Slot</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxOutRef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Value</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ValidatorScript</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">scriptTxIn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">scriptTxOut</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Ledger</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Ledger</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ledger.Validation</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTx</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTxIn</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>                                              </span><span class="hs-identifier hs-type">PendingTxOutType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Ledger.Validation</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Validation</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Wallet</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WalletAPI</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WalletAPIError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwOtherError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pubKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">createTxAndSubmit</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                      </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">||</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">{- note [Futures in Plutus]

A futures contract (&quot;future&quot;) is an agreement to change ownership of an
asset at a certain time (the delivery time) for an agreed price (the forward
price). The time of the transfer, and the price, are fixed at the beginning of the contract.

On the mockchain we only have one type of asset (namely, Ada coin value),
so we simply exchange the difference in price between the forward price and the
actual price. This is called a &quot;cash settlement&quot;.

The agreement involves two parties, a buyer (long position) and a seller (short
position). At the delivery time the actual price of the asset (spot price) is
quite likely different from the forward price. If the spot price is higher than
the forward price, then the seller transfers the difference to the buyer. If
the spot price is lower than the forward price, then the buyer transfers money
to the seller. In either case there is a risk that the payer does not meet their
obligation (by simply not paying). To protect against this risk, the contract
includes a kind of deposit called &quot;margin&quot;.

Each party deposits an initial margin. If the price moves against the seller,
then the seller has to top up their margin periodically (in our case, once each
block). Likewise, if it moves against the buyer then the buyer has to top up
their margin. If either party fails to make a margin payment then the contract
will be settled early.

The current value of the underlying asset is determined by an oracle. See note
[Oracles] in Language.PlutusTx.Coordination.Contracts.

-}</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">-- | Initialise the futures contract by paying the initial margin.</span><span>
</span><a name="line-72"></a><span class="hs-comment">--</span><span>
</span><a name="line-73"></a><span class="hs-identifier">initialise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">WalletAPIError</span><span> </span><a href="#local-6989586621679212747"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-identifier hs-type">WalletAPI</span><span> </span><a href="#local-6989586621679212747"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span>
</span><a name="line-77"></a><span>    </span><span class="hs-comment">-- ^ Identity of the holder of the long position</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-comment">-- ^ Identity of the holder of the short position</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679212747"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><a name="initialise"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#initialise"><span class="hs-identifier">initialise</span></a></a><span> </span><a name="local-6989586621679212748"><a href="#local-6989586621679212748"><span class="hs-identifier">long</span></a></a><span> </span><a name="local-6989586621679212749"><a href="#local-6989586621679212749"><span class="hs-identifier">short</span></a></a><span> </span><a name="local-6989586621679212750"><a href="#local-6989586621679212750"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-84"></a><span>        </span><a name="local-6989586621679212751"><a href="#local-6989586621679212751"><span class="hs-identifier">im</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">futureInitialMargin</span><span> </span><a href="#local-6989586621679212750"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-85"></a><span>        </span><a name="local-6989586621679212752"><a href="#local-6989586621679212752"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scriptTxOut</span><span> </span><a href="#local-6989586621679212751"><span class="hs-identifier hs-var">im</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span> </span><a href="#local-6989586621679212750"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212753"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-86"></a><span>        </span><a name="local-6989586621679212753"><a href="#local-6989586621679212753"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DataScript</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-var">FutureData</span></a><span> </span><a href="#local-6989586621679212748"><span class="hs-identifier hs-var">long</span></a><span> </span><a href="#local-6989586621679212749"><span class="hs-identifier hs-var">short</span></a><span> </span><a href="#local-6989586621679212751"><span class="hs-identifier hs-var">im</span></a><span> </span><a href="#local-6989586621679212751"><span class="hs-identifier hs-var">im</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679212754"><a href="#local-6989586621679212754"><span class="hs-identifier">payment</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679212755"><a href="#local-6989586621679212755"><span class="hs-identifier">change</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">createPaymentWithChange</span><span> </span><a href="#local-6989586621679212751"><span class="hs-identifier hs-var">im</span></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createTxAndSubmit</span><span> </span><a href="#local-6989586621679212754"><span class="hs-identifier hs-var">payment</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212752"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><a href="#local-6989586621679212755"><span class="hs-identifier hs-var">change</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- | Close the position by extracting the payment</span><span>
</span><a name="line-92"></a><span class="hs-identifier">settle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">WalletAPIError</span><span> </span><a href="#local-6989586621679212746"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-identifier hs-type">WalletAPI</span><span> </span><a href="#local-6989586621679212746"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TxOutRef</span><span class="hs-special">]</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-type">FutureData</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679212746"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><a name="settle"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#settle"><span class="hs-identifier">settle</span></a></a><span> </span><a name="local-6989586621679212756"><a href="#local-6989586621679212756"><span class="hs-identifier">refs</span></a></a><span> </span><a name="local-6989586621679212757"><a href="#local-6989586621679212757"><span class="hs-identifier">ft</span></a></a><span> </span><a name="local-6989586621679212758"><a href="#local-6989586621679212758"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679212759"><a href="#local-6989586621679212759"><span class="hs-identifier">ov</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-102"></a><span>        </span><a name="local-6989586621679212760"><a href="#local-6989586621679212760"><span class="hs-identifier">forwardPrice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">futureUnitPrice</span><span> </span><a href="#local-6989586621679212757"><span class="hs-identifier hs-var">ft</span></a><span>
</span><a name="line-103"></a><span>        </span><span class="hs-identifier hs-var">OracleValue</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679212761"><a href="#local-6989586621679212761"><span class="hs-identifier">spotPrice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212759"><span class="hs-identifier hs-var">ov</span></a><span>
</span><a name="line-104"></a><span>        </span><a name="local-6989586621679212762"><a href="#local-6989586621679212762"><span class="hs-identifier">delta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">futureUnits</span><span> </span><a href="#local-6989586621679212757"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212761"><span class="hs-identifier hs-var">spotPrice</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679212760"><span class="hs-identifier hs-var">forwardPrice</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>        </span><a name="local-6989586621679212763"><a href="#local-6989586621679212763"><span class="hs-identifier">longOut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">futureDataMarginLong</span><span> </span><a href="#local-6989586621679212758"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679212762"><span class="hs-identifier hs-var">delta</span></a><span>
</span><a name="line-106"></a><span>        </span><a name="local-6989586621679212764"><a href="#local-6989586621679212764"><span class="hs-identifier">shortOut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">futureDataMarginShort</span><span> </span><a href="#local-6989586621679212758"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679212762"><span class="hs-identifier hs-var">delta</span></a><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621679212765"><a href="#local-6989586621679212765"><span class="hs-identifier">red</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.RedeemerScript</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Settle"><span class="hs-identifier hs-var">Settle</span></a><span> </span><a href="#local-6989586621679212759"><span class="hs-identifier hs-var">ov</span></a><span>
</span><a name="line-108"></a><span>        </span><a name="local-6989586621679212766"><a href="#local-6989586621679212766"><span class="hs-identifier">outs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-109"></a><span>            </span><span class="hs-identifier hs-var">Ledger.pubKeyTxOut</span><span> </span><a href="#local-6989586621679212763"><span class="hs-identifier hs-var">longOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">futureDataLong</span><span> </span><a href="#local-6989586621679212758"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-110"></a><span>            </span><span class="hs-identifier hs-var">Ledger.pubKeyTxOut</span><span> </span><a href="#local-6989586621679212764"><span class="hs-identifier hs-var">shortOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">futureDataShort</span><span> </span><a href="#local-6989586621679212758"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-112"></a><span>        </span><a name="local-6989586621679212767"><a href="#local-6989586621679212767"><span class="hs-identifier">inp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679212768"><a href="#local-6989586621679212768"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">scriptTxIn</span><span> </span><a href="#local-6989586621679212768"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span> </span><a href="#local-6989586621679212757"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212765"><span class="hs-identifier hs-var">red</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679212756"><span class="hs-identifier hs-var">refs</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createTxAndSubmit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679212767"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212766"><span class="hs-identifier hs-var">outs</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- | Settle the position early if a margin payment has been missed.</span><span>
</span><a name="line-116"></a><span class="hs-identifier">settleEarly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">WalletAPIError</span><span> </span><a href="#local-6989586621679212745"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-identifier hs-type">WalletAPI</span><span> </span><a href="#local-6989586621679212745"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TxOutRef</span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-type">FutureData</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679212745"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><a name="settleEarly"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#settleEarly"><span class="hs-identifier">settleEarly</span></a></a><span> </span><a name="local-6989586621679212769"><a href="#local-6989586621679212769"><span class="hs-identifier">refs</span></a></a><span> </span><a name="local-6989586621679212770"><a href="#local-6989586621679212770"><span class="hs-identifier">ft</span></a></a><span> </span><a name="local-6989586621679212771"><a href="#local-6989586621679212771"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679212772"><a href="#local-6989586621679212772"><span class="hs-identifier">ov</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679212773"><a href="#local-6989586621679212773"><span class="hs-identifier">totalVal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">futureDataMarginLong</span><span> </span><a href="#local-6989586621679212771"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">futureDataMarginShort</span><span> </span><a href="#local-6989586621679212771"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-126"></a><span>        </span><a name="local-6989586621679212774"><a href="#local-6989586621679212774"><span class="hs-identifier">outs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Ledger.pubKeyTxOut</span><span> </span><a href="#local-6989586621679212773"><span class="hs-identifier hs-var">totalVal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">futureDataLong</span><span> </span><a href="#local-6989586621679212771"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-127"></a><span>        </span><a name="local-6989586621679212775"><a href="#local-6989586621679212775"><span class="hs-identifier">inp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679212777"><a href="#local-6989586621679212777"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">scriptTxIn</span><span> </span><a href="#local-6989586621679212777"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span> </span><a href="#local-6989586621679212770"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212776"><span class="hs-identifier hs-var">red</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679212769"><span class="hs-identifier hs-var">refs</span></a><span>
</span><a name="line-128"></a><span>        </span><a name="local-6989586621679212776"><a href="#local-6989586621679212776"><span class="hs-identifier">red</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.RedeemerScript</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Settle"><span class="hs-identifier hs-var">Settle</span></a><span> </span><a href="#local-6989586621679212772"><span class="hs-identifier hs-var">ov</span></a><span>
</span><a name="line-129"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createTxAndSubmit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679212775"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212774"><span class="hs-identifier hs-var">outs</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">adjustMargin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">WalletAPIError</span><span> </span><a href="#local-6989586621679212744"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-identifier hs-type">WalletAPI</span><span> </span><a href="#local-6989586621679212744"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TxOutRef</span><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-type">FutureData</span></a><span>
</span><a name="line-137"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ledger.Value</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679212744"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><a name="adjustMargin"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#adjustMargin"><span class="hs-identifier">adjustMargin</span></a></a><span> </span><a name="local-6989586621679212778"><a href="#local-6989586621679212778"><span class="hs-identifier">refs</span></a></a><span> </span><a name="local-6989586621679212779"><a href="#local-6989586621679212779"><span class="hs-identifier">ft</span></a></a><span> </span><a name="local-6989586621679212780"><a href="#local-6989586621679212780"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679212781"><a href="#local-6989586621679212781"><span class="hs-identifier">vl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621679212782"><a href="#local-6989586621679212782"><span class="hs-identifier">pk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">pubKey</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">myKeyPair</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679212783"><a href="#local-6989586621679212783"><span class="hs-identifier">payment</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679212784"><a href="#local-6989586621679212784"><span class="hs-identifier">change</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">createPaymentWithChange</span><span> </span><a href="#local-6989586621679212781"><span class="hs-identifier hs-var">vl</span></a><span>
</span><a name="line-142"></a><span>    </span><a name="local-6989586621679212786"><a href="#local-6989586621679212786"><span class="hs-identifier">fd'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679212785"><a href="#local-6989586621679212785"><span class="hs-identifier">fd''</span></a></a><span>
</span><a name="line-143"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679212782"><span class="hs-identifier hs-var">pk</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">futureDataLong</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">futureDataMarginLong</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212781"><span class="hs-identifier hs-var">vl</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">futureDataMarginLong</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679212782"><span class="hs-identifier hs-var">pk</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">futureDataShort</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">futureDataMarginShort</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212781"><span class="hs-identifier hs-var">vl</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">futureDataMarginShort</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwOtherError</span><span> </span><span class="hs-string">&quot;Private key is not part of futures contrat&quot;</span><span>
</span><a name="line-146"></a><span>            </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212785"><span class="hs-identifier hs-var">fd''</span></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-148"></a><span>        </span><a name="local-6989586621679212787"><a href="#local-6989586621679212787"><span class="hs-identifier">red</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.RedeemerScript</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#AdjustMargin"><span class="hs-identifier hs-var">AdjustMargin</span></a><span>
</span><a name="line-149"></a><span>        </span><a name="local-6989586621679212788"><a href="#local-6989586621679212788"><span class="hs-identifier">ds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DataScript</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><a href="#local-6989586621679212786"><span class="hs-identifier hs-var">fd'</span></a><span>
</span><a name="line-150"></a><span>        </span><a name="local-6989586621679212789"><a href="#local-6989586621679212789"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scriptTxOut</span><span> </span><a href="#local-6989586621679212790"><span class="hs-identifier hs-var">outVal</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span> </span><a href="#local-6989586621679212779"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212788"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-151"></a><span>        </span><a name="local-6989586621679212790"><a href="#local-6989586621679212790"><span class="hs-identifier">outVal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212781"><span class="hs-identifier hs-var">vl</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">futureDataMarginLong</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">futureDataMarginShort</span><span> </span><a href="#local-6989586621679212780"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>        </span><a name="local-6989586621679212791"><a href="#local-6989586621679212791"><span class="hs-identifier">inp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679212792"><a href="#local-6989586621679212792"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">scriptTxIn</span><span> </span><a href="#local-6989586621679212792"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier hs-var">validatorScript</span></a><span> </span><a href="#local-6989586621679212779"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212787"><span class="hs-identifier hs-var">red</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679212778"><span class="hs-identifier hs-var">refs</span></a><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createTxAndSubmit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.union</span><span> </span><a href="#local-6989586621679212783"><span class="hs-identifier hs-var">payment</span></a><span> </span><a href="#local-6989586621679212791"><span class="hs-identifier hs-var">inp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212789"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><a href="#local-6989586621679212784"><span class="hs-identifier hs-var">change</span></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Basic data of a futures contract. `Future` contains all values that do not</span><span>
</span><a name="line-157"></a><span class="hs-comment">--   change during the lifetime of the contract.</span><span>
</span><a name="line-158"></a><span class="hs-comment">--</span><span>
</span><a name="line-159"></a><span class="hs-keyword">data</span><span> </span><a name="Future"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier">Future</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Future"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier">Future</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-160"></a><span>    </span><a name="futureDeliveryDate"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureDeliveryDate"><span class="hs-identifier">futureDeliveryDate</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Slot</span><span class="hs-special">,</span><span>
</span><a name="line-161"></a><span>    </span><a name="futureUnits"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureUnits"><span class="hs-identifier">futureUnits</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-162"></a><span>    </span><a name="futureUnitPrice"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureUnitPrice"><span class="hs-identifier">futureUnitPrice</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">,</span><span>
</span><a name="line-163"></a><span>    </span><a name="futureInitialMargin"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureInitialMargin"><span class="hs-identifier">futureInitialMargin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">,</span><span>
</span><a name="line-164"></a><span>    </span><a name="futurePriceOracle"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futurePriceOracle"><span class="hs-identifier">futurePriceOracle</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span>
</span><a name="line-165"></a><span>    </span><a name="futureMarginPenalty"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureMarginPenalty"><span class="hs-identifier">futureMarginPenalty</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-comment">-- ^ How much a participant loses if they fail to make the required margin</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">--   payments.</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Generic</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">-- | The current &quot;state&quot; of the futures contract. `FutureData` contains values</span><span>
</span><a name="line-171"></a><span class="hs-comment">--   that may change during the lifetime of the contract. This is the data</span><span>
</span><a name="line-172"></a><span class="hs-comment">--   script.</span><span>
</span><a name="line-173"></a><span class="hs-comment">--</span><span>
</span><a name="line-174"></a><span class="hs-keyword">data</span><span> </span><a name="FutureData"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier">FutureData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FutureData"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier">FutureData</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-175"></a><span>    </span><a name="futureDataLong"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureDataLong"><span class="hs-identifier">futureDataLong</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- ^ Holder of the long position (buyer)</span><span>
</span><a name="line-177"></a><span>    </span><a name="futureDataShort"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureDataShort"><span class="hs-identifier">futureDataShort</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span class="hs-special">,</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- ^ Holder of the short position (seller)</span><span>
</span><a name="line-179"></a><span>    </span><a name="futureDataMarginLong"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureDataMarginLong"><span class="hs-identifier">futureDataMarginLong</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">,</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-comment">-- ^ Current balance of the margin account of the long position</span><span>
</span><a name="line-181"></a><span>    </span><a name="futureDataMarginShort"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#futureDataMarginShort"><span class="hs-identifier">futureDataMarginShort</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">-- ^ Current balance of the margin account of the short position</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Generic</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- | Actions that either participant may take. This is the redeemer script.</span><span>
</span><a name="line-186"></a><span class="hs-keyword">data</span><span> </span><a name="FutureRedeemer"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureRedeemer"><span class="hs-identifier">FutureRedeemer</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-187"></a><span>      </span><a name="AdjustMargin"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#AdjustMargin"><span class="hs-identifier">AdjustMargin</span></a></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">-- ^ Make a margin payment</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Settle"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Settle"><span class="hs-identifier">Settle</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OracleValue</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-comment">-- ^ Settle the contract</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Generic</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">validatorScript</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ValidatorScript</span><span>
</span><a name="line-194"></a><a name="validatorScript"><a href="Language.PlutusTx.Coordination.Contracts.Future.html#validatorScript"><span class="hs-identifier">validatorScript</span></a></a><span> </span><a name="local-6989586621679212793"><a href="#local-6989586621679212793"><span class="hs-identifier">ft</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValidatorScript</span><span> </span><a href="#local-6989586621679212794"><span class="hs-identifier hs-var">val</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621679212794"><a href="#local-6989586621679212794"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.applyScript</span><span> </span><a href="#local-6989586621679212795"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ledger.lifted</span><span> </span><a href="#local-6989586621679212793"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621679212795"><a href="#local-6989586621679212795"><span class="hs-identifier">inner</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ledger.fromCompiledCode</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.compile</span><span> </span><span class="hs-special">[||</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-glyph">\</span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Future"><span class="hs-identifier hs-var">Future</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679212803"><a href="#local-6989586621679212803"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureRedeemer"><span class="hs-identifier hs-type">FutureRedeemer</span></a><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#FutureData"><span class="hs-identifier hs-var">FutureData</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679212808"><a href="#local-6989586621679212808"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTx</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span>            </span><span class="hs-keyword">let</span><span>
</span><a name="line-200"></a><span>                </span><span class="hs-identifier hs-var">PendingTx</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679212809"><a href="#local-6989586621679212809"><span class="hs-identifier">outs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Slot</span><span> </span><a name="local-6989586621679212810"><a href="#local-6989586621679212810"><span class="hs-identifier">sl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTxIn</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679212811"><a href="#local-6989586621679212811"><span class="hs-identifier">witness</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212808"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-201"></a><span>                </span><a name="local-6989586621679212812"><a href="#local-6989586621679212812"><span class="hs-identifier">ownHash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679212811"><span class="hs-identifier hs-var">witness</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-202"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679212827"><a href="#local-6989586621679212827"><span class="hs-identifier">vhash</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679212827"><span class="hs-identifier hs-var">vhash</span></a><span>
</span><a name="line-203"></a><span>                    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>                </span><span class="hs-identifier">eqPk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-206"></a><span>                </span><a name="local-6989586621679212813"><a href="#local-6989586621679212813"><span class="hs-identifier">eqPk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.eqPubKey</span><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>                </span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator">&amp;&amp;</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-special">(</span><span class="hs-operator">&amp;&amp;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-210"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679212814"><a href="#local-6989586621679212814"><span class="hs-operator">&amp;&amp;</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.and</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>                </span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator">||</span><span>
</span><a name="line-213"></a><span>                </span><span class="hs-special">(</span><span class="hs-operator">||</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-214"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679212815"><a href="#local-6989586621679212815"><span class="hs-operator">||</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.or</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>                </span><span class="hs-identifier">forwardPrice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-217"></a><span>                </span><a name="local-6989586621679212816"><a href="#local-6989586621679212816"><span class="hs-identifier">forwardPrice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212832"><a href="#local-6989586621679212832"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212799"><span class="hs-identifier hs-var">futureUnitPrice</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212832"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>                </span><span class="hs-identifier">marginShort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-220"></a><span>                </span><a name="local-6989586621679212817"><a href="#local-6989586621679212817"><span class="hs-identifier">marginShort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212833"><a href="#local-6989586621679212833"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212807"><span class="hs-identifier hs-var">futureDataMarginShort</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212833"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>                </span><span class="hs-identifier">marginLong</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-223"></a><span>                </span><a name="local-6989586621679212818"><a href="#local-6989586621679212818"><span class="hs-identifier">marginLong</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212834"><a href="#local-6989586621679212834"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212806"><span class="hs-identifier hs-var">futureDataMarginLong</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212834"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span>                </span><span class="hs-identifier">penalty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-226"></a><span>                </span><a name="local-6989586621679212819"><a href="#local-6989586621679212819"><span class="hs-identifier">penalty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212835"><a href="#local-6989586621679212835"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212802"><span class="hs-identifier hs-var">futureMarginPenalty</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212835"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>                </span><span class="hs-identifier">deliveryDate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-229"></a><span>                </span><a name="local-6989586621679212820"><a href="#local-6989586621679212820"><span class="hs-identifier">deliveryDate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Slot</span><span> </span><a name="local-6989586621679212836"><a href="#local-6989586621679212836"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212797"><span class="hs-identifier hs-var">futureDeliveryDate</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679212836"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>                </span><span class="hs-comment">-- Compute the required margin from the current price of the</span><span>
</span><a name="line-232"></a><span>                </span><span class="hs-comment">-- underlying asset.</span><span>
</span><a name="line-233"></a><span>                </span><span class="hs-identifier">requiredMargin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-234"></a><span>                </span><a name="local-6989586621679212821"><a href="#local-6989586621679212821"><span class="hs-identifier">requiredMargin</span></a></a><span> </span><a name="local-6989586621679212837"><a href="#local-6989586621679212837"><span class="hs-identifier">spotPrice</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-235"></a><span>                    </span><span class="hs-keyword">let</span><span>
</span><a name="line-236"></a><span>                        </span><a name="local-6989586621679212838"><a href="#local-6989586621679212838"><span class="hs-identifier">delta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212798"><span class="hs-identifier hs-var">futureUnits</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212837"><span class="hs-identifier hs-var">spotPrice</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679212816"><span class="hs-identifier hs-var">forwardPrice</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>                    </span><span class="hs-keyword">in</span><span>
</span><a name="line-238"></a><span>                        </span><a href="#local-6989586621679212819"><span class="hs-identifier hs-var">penalty</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679212838"><span class="hs-identifier hs-var">delta</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>                </span><span class="hs-identifier">isPubKeyOutput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-241"></a><span>                </span><a name="local-6989586621679212822"><a href="#local-6989586621679212822"><span class="hs-identifier">isPubKeyOutput</span></a></a><span> </span><a name="local-6989586621679212839"><a href="#local-6989586621679212839"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679212840"><a href="#local-6989586621679212840"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.maybe</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.eqPubKey</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212840"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.pubKeyOutput</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212839"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>                </span><span class="hs-comment">--  | Check if a `PendingTxOut` is a public key output for the given pub. key and value</span><span>
</span><a name="line-244"></a><span>                </span><span class="hs-identifier">paidOutTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PubKey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PendingTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-245"></a><span>                </span><a name="local-6989586621679212823"><a href="#local-6989586621679212823"><span class="hs-identifier">paidOutTo</span></a></a><span> </span><a name="local-6989586621679212844"><a href="#local-6989586621679212844"><span class="hs-identifier">vl</span></a></a><span> </span><a name="local-6989586621679212845"><a href="#local-6989586621679212845"><span class="hs-identifier">pk</span></a></a><span> </span><a name="local-6989586621679212846"><a href="#local-6989586621679212846"><span class="hs-identifier">txo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-246"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212847"><a href="#local-6989586621679212847"><span class="hs-identifier">vl'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212846"><span class="hs-identifier hs-var">txo</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-247"></a><span>                    </span><a href="#local-6989586621679212822"><span class="hs-identifier hs-var">isPubKeyOutput</span></a><span> </span><a href="#local-6989586621679212846"><span class="hs-identifier hs-var">txo</span></a><span> </span><a href="#local-6989586621679212845"><span class="hs-identifier hs-var">pk</span></a><span> </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212844"><span class="hs-identifier hs-var">vl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679212847"><span class="hs-identifier hs-var">vl'</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>                </span><span class="hs-identifier">verifyOracle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OracleValue</span><span> </span><a href="#local-6989586621679212826"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Slot</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679212826"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>                </span><a name="local-6989586621679212824"><a href="#local-6989586621679212824"><span class="hs-identifier">verifyOracle</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OracleValue</span><span> </span><a name="local-6989586621679212848"><a href="#local-6989586621679212848"><span class="hs-identifier">pk</span></a></a><span> </span><a name="local-6989586621679212849"><a href="#local-6989586621679212849"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679212850"><a href="#local-6989586621679212850"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-251"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679212848"><span class="hs-identifier hs-var">pk</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679212813"><span class="hs-identifier hs-var">eqPk</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679212801"><span class="hs-identifier hs-var">futurePriceOracle</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212849"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679212850"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>                </span><a name="local-6989586621679212825"><a href="#local-6989586621679212825"><span class="hs-identifier">isValid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-254"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679212803"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span>                        </span><span class="hs-comment">-- Settling the contract is allowed if any of three conditions hold:</span><span>
</span><a name="line-257"></a><span>                        </span><span class="hs-comment">--</span><span>
</span><a name="line-258"></a><span>                        </span><span class="hs-comment">-- 1. The `deliveryDate` has been reached. In this case both parties get what is left of their margin</span><span>
</span><a name="line-259"></a><span>                        </span><span class="hs-comment">-- plus/minus the difference between spot and forward price.</span><span>
</span><a name="line-260"></a><span>                        </span><span class="hs-comment">-- 2. The owner of the long position has failed to make a margin payment. In this case the owner of the short position gets both margins.</span><span>
</span><a name="line-261"></a><span>                        </span><span class="hs-comment">-- 3. The owner of the short position has failed to make a margin payment. In this case the owner of the long position gets both margins.</span><span>
</span><a name="line-262"></a><span>                        </span><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span>                        </span><span class="hs-comment">-- In case (1) there are two payments (1 to each of the participants). In cases (2) and (3) there is only one payment.</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span>                        </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#Settle"><span class="hs-identifier hs-var">Settle</span></a><span> </span><a name="local-6989586621679212852"><a href="#local-6989586621679212852"><span class="hs-identifier">ov</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-266"></a><span>                            </span><span class="hs-keyword">let</span><span>
</span><a name="line-267"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212853"><a href="#local-6989586621679212853"><span class="hs-identifier">spotPrice</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212824"><span class="hs-identifier hs-var">verifyOracle</span></a><span> </span><a href="#local-6989586621679212852"><span class="hs-identifier hs-var">ov</span></a><span>
</span><a name="line-268"></a><span>                                </span><a name="local-6989586621679212854"><a href="#local-6989586621679212854"><span class="hs-identifier">delta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212798"><span class="hs-identifier hs-var">futureUnits</span></a><span> </span><span class="hs-operator hs-var">*</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679212853"><span class="hs-identifier hs-var">spotPrice</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679212816"><span class="hs-identifier hs-var">forwardPrice</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>                                </span><a name="local-6989586621679212855"><a href="#local-6989586621679212855"><span class="hs-identifier">expShort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212817"><span class="hs-identifier hs-var">marginShort</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679212854"><span class="hs-identifier hs-var">delta</span></a><span>
</span><a name="line-270"></a><span>                                </span><a name="local-6989586621679212856"><a href="#local-6989586621679212856"><span class="hs-identifier">expLong</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212818"><span class="hs-identifier hs-var">marginLong</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679212854"><span class="hs-identifier hs-var">delta</span></a><span>
</span><a name="line-271"></a><span>                                </span><a name="local-6989586621679212857"><a href="#local-6989586621679212857"><span class="hs-identifier">slotvalid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212810"><span class="hs-identifier hs-var">sl</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679212820"><span class="hs-identifier hs-var">deliveryDate</span></a><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span>                                </span><a name="local-6989586621679212858"><a href="#local-6989586621679212858"><span class="hs-identifier">canSettle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-274"></a><span>                                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679212809"><span class="hs-identifier hs-var">outs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-275"></a><span>                                        </span><a name="local-6989586621679212859"><a href="#local-6989586621679212859"><span class="hs-identifier">o1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679212860"><a href="#local-6989586621679212860"><span class="hs-identifier">o2</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-276"></a><span>                                            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679212861"><a href="#local-6989586621679212861"><span class="hs-identifier">paymentsValid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-277"></a><span>                                                    </span><span class="hs-special">(</span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212855"><span class="hs-identifier hs-var">expShort</span></a><span> </span><a href="#local-6989586621679212805"><span class="hs-identifier hs-var">futureDataShort</span></a><span> </span><a href="#local-6989586621679212859"><span class="hs-identifier hs-var">o1</span></a><span> </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212856"><span class="hs-identifier hs-var">expLong</span></a><span> </span><a href="#local-6989586621679212804"><span class="hs-identifier hs-var">futureDataLong</span></a><span> </span><a href="#local-6989586621679212860"><span class="hs-identifier hs-var">o2</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>                                                    </span><a href="#local-6989586621679212815"><span class="hs-operator hs-var">||</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212855"><span class="hs-identifier hs-var">expShort</span></a><span> </span><a href="#local-6989586621679212805"><span class="hs-identifier hs-var">futureDataShort</span></a><span> </span><a href="#local-6989586621679212860"><span class="hs-identifier hs-var">o2</span></a><span> </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212856"><span class="hs-identifier hs-var">expLong</span></a><span> </span><a href="#local-6989586621679212804"><span class="hs-identifier hs-var">futureDataLong</span></a><span> </span><a href="#local-6989586621679212859"><span class="hs-identifier hs-var">o1</span></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>                                            </span><span class="hs-keyword">in</span><span>
</span><a name="line-280"></a><span>                                                </span><a href="#local-6989586621679212857"><span class="hs-identifier hs-var">slotvalid</span></a><span> </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212861"><span class="hs-identifier hs-var">paymentsValid</span></a><span>
</span><a name="line-281"></a><span>                                        </span><a name="local-6989586621679212862"><a href="#local-6989586621679212862"><span class="hs-identifier">o1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-282"></a><span>                                            </span><span class="hs-keyword">let</span><span>
</span><a name="line-283"></a><span>                                                </span><a name="local-6989586621679212863"><a href="#local-6989586621679212863"><span class="hs-identifier">totalMargin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212817"><span class="hs-identifier hs-var">marginShort</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679212818"><span class="hs-identifier hs-var">marginLong</span></a><span>
</span><a name="line-284"></a><span>                                                </span><a name="local-6989586621679212864"><a href="#local-6989586621679212864"><span class="hs-identifier">case2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212818"><span class="hs-identifier hs-var">marginLong</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679212821"><span class="hs-identifier hs-var">requiredMargin</span></a><span> </span><a href="#local-6989586621679212853"><span class="hs-identifier hs-var">spotPrice</span></a><span>
</span><a name="line-285"></a><span>                                                        </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212863"><span class="hs-identifier hs-var">totalMargin</span></a><span> </span><a href="#local-6989586621679212805"><span class="hs-identifier hs-var">futureDataShort</span></a><span> </span><a href="#local-6989586621679212862"><span class="hs-identifier hs-var">o1</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>                                                </span><a name="local-6989586621679212865"><a href="#local-6989586621679212865"><span class="hs-identifier">case3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679212817"><span class="hs-identifier hs-var">marginShort</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679212821"><span class="hs-identifier hs-var">requiredMargin</span></a><span> </span><a href="#local-6989586621679212853"><span class="hs-identifier hs-var">spotPrice</span></a><span>
</span><a name="line-288"></a><span>                                                        </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679212823"><span class="hs-identifier hs-var">paidOutTo</span></a><span> </span><a href="#local-6989586621679212863"><span class="hs-identifier hs-var">totalMargin</span></a><span> </span><a href="#local-6989586621679212804"><span class="hs-identifier hs-var">futureDataLong</span></a><span> </span><a href="#local-6989586621679212862"><span class="hs-identifier hs-var">o1</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>                                            </span><span class="hs-keyword">in</span><span>
</span><a name="line-291"></a><span>                                                </span><a href="#local-6989586621679212864"><span class="hs-identifier hs-var">case2</span></a><span> </span><a href="#local-6989586621679212815"><span class="hs-operator hs-var">||</span></a><span> </span><a href="#local-6989586621679212865"><span class="hs-identifier hs-var">case3</span></a><span>
</span><a name="line-292"></a><span>                                        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>                            </span><span class="hs-keyword">in</span><span>
</span><a name="line-295"></a><span>                               </span><a href="#local-6989586621679212858"><span class="hs-identifier hs-var">canSettle</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>                        </span><span class="hs-comment">-- For adjusting the margin we simply check that the amount locked in the contract</span><span>
</span><a name="line-298"></a><span>                        </span><span class="hs-comment">-- is larger than it was before.</span><span>
</span><a name="line-299"></a><span>                        </span><span class="hs-comment">--</span><span>
</span><a name="line-300"></a><span>                        </span><a href="Language.PlutusTx.Coordination.Contracts.Future.html#AdjustMargin"><span class="hs-identifier hs-var">AdjustMargin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-301"></a><span>                            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679212809"><span class="hs-identifier hs-var">outs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-302"></a><span>                                </span><a name="local-6989586621679212866"><a href="#local-6989586621679212866"><span class="hs-identifier">ot</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-303"></a><span>                                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679212866"><span class="hs-identifier hs-var">ot</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-304"></a><span>                                        </span><span class="hs-identifier hs-var">PendingTxOut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Value</span><span> </span><a name="local-6989586621679212867"><a href="#local-6989586621679212867"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679212868"><a href="#local-6989586621679212868"><span class="hs-identifier">vh</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">DataTxOut</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-305"></a><span>                                            </span><a href="#local-6989586621679212867"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679212817"><span class="hs-identifier hs-var">marginShort</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679212818"><span class="hs-identifier hs-var">marginLong</span></a><span>
</span><a name="line-306"></a><span>                                            </span><a href="#local-6989586621679212814"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">Validation.eqValidator</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679212868"><span class="hs-identifier hs-var">vh</span></a><span> </span><a href="#local-6989586621679212812"><span class="hs-identifier hs-var">ownHash</span></a><span>
</span><a name="line-307"></a><span>                                        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>                                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-310"></a><span>            </span><span class="hs-keyword">in</span><span>
</span><a name="line-311"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679212825"><span class="hs-identifier hs-var">isValid</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">$$(</span><span class="hs-identifier hs-var">PlutusTx.error</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier hs-var">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">Future</span><span>
</span><a name="line-315"></a><span class="hs-identifier hs-var">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">FutureData</span><span>
</span><a name="line-316"></a><span class="hs-identifier hs-var">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">FutureRedeemer</span><span>
</span><a name="line-317"></a></pre></body></html>