<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DefaultSignatures #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures    #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds         #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell   #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns      #-}</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusTx.Lift.Class</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>  </span><a href="Language.PlutusTx.Lift.Class.html#Lift"><span class="hs-identifier hs-type">Lift</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#makeTypeable"><span class="hs-identifier hs-var">makeTypeable</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#makeLift"><span class="hs-identifier hs-var">makeLift</span></a><span class="hs-special">)</span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Lift.THUtils.html"><span class="hs-identifier">Language.PlutusTx.Lift.THUtils</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR.Compiler.Definitions</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR.Compiler.Names</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR.MkPir</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.MkPlc</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusCore.Quote</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>                   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.State</span><span>                    </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Datatype</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>                               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span>                               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sortBy</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Proxy</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-- Apparently this is how you're supposed to fail at TH time.</span><span>
</span><a name="line-41"></a><span class="hs-identifier">die</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679115981"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115981"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679115982"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-42"></a><a name="die"><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier">die</span></a></a><span> </span><a name="local-6989586621679115983"><a href="#local-6989586621679115983"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Generating Lift instances: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679115983"><span class="hs-identifier hs-var">message</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">{- Note [Compiling at TH time and runtime]
We want to reuse PIR's machinery for defining datatypes. However, one cannot
get a PLC Type consisting of the compiled PIR type, because the compilation of the
definitions is done by making a *term*.

So we use the abstract support for handling definitions in PIR, MonadDefs. Typeable
then has `typeRep :: (MonadDefs m, MonadQuote m) =&gt; Proxy a -&gt; m (Type TyName Name ())`,
which says that you can get the type in some context where you can make definitions (which
you will later have to discharge yourself).

This means that the TH expressions we are generating are not for `Type`s directly, but rather
for monadic expressions that will, at runtime, compute types. We are effectively generating
a specialized compiler.

We thus have two pieces of compilation going on here:
- At TH time, we reify information about datatypes, and construct specialized compilation expressions
  for the various parts.
- At runtime, we actually run these and create definitions etc.

The interplay between the parts happening at TH time and the parts happening at runtime is somewhat
awkward, but I couldn't think of a better way of doing it.

A particularly awkward feature is that the typeclass constriants required by the code in each
instance are going to be different, and so we can't use reusable functions, instead we need to
inline all the definitions so that the overall expression can have the right constraints inferred.
-}</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">-- Constraints</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | Make a 'Typeable' constraint.</span><span>
</span><a name="line-74"></a><span class="hs-identifier">typeablePir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-75"></a><a name="typeablePir"><a href="Language.PlutusTx.Lift.Class.html#typeablePir"><span class="hs-identifier">typeablePir</span></a></a><span> </span><a name="local-6989586621679115984"><a href="#local-6989586621679115984"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.classPred</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Typeable</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679115984"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | Make a 'Lift' constraint.</span><span>
</span><a name="line-78"></a><span class="hs-identifier">liftPir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-79"></a><a name="liftPir"><a href="Language.PlutusTx.Lift.Class.html#liftPir"><span class="hs-identifier">liftPir</span></a></a><span> </span><a name="local-6989586621679115985"><a href="#local-6989586621679115985"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.classPred</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Lift</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679115985"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">{- Note [Closed constraints]
There is no point adding constraints that are &quot;closed&quot;, i.e. don't mention any of the
instance type variables. These will either be satisfied by other instances in scope
(in which case GHC will complain at you), or be unsatisfied in which case the user will
get a useful error anyway.
-}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-identifier">isClosedConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Pred</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-89"></a><a name="isClosedConstraint"><a href="Language.PlutusTx.Lift.Class.html#isClosedConstraint"><span class="hs-identifier">isClosedConstraint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TH.freeVariables</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- Dependencies at TH time</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">{- Note [Tracking dependencies]
While running at TH time, we track the requirements that we need in order to be able to compile
the given type/term, which are things like &quot;must be able to type the constructor argument types&quot;.

These are then cashed out into constraints on the instance.
-}</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">data</span><span> </span><a name="Dep"><a href="Language.PlutusTx.Lift.Class.html#Dep"><span class="hs-identifier">Dep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TypeableDep"><a href="Language.PlutusTx.Lift.Class.html#TypeableDep"><span class="hs-identifier">TypeableDep</span></a></a><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="LiftDep"><a href="Language.PlutusTx.Lift.Class.html#LiftDep"><span class="hs-identifier">LiftDep</span></a></a><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span class="hs-keyword">type</span><span> </span><a name="Deps"><a href="Language.PlutusTx.Lift.Class.html#Deps"><span class="hs-identifier">Deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#Dep"><span class="hs-identifier hs-type">Dep</span></a><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-identifier">toConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#Dep"><span class="hs-identifier hs-type">Dep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Pred</span><span>
</span><a name="line-104"></a><a name="toConstraint"><a href="Language.PlutusTx.Lift.Class.html#toConstraint"><span class="hs-identifier">toConstraint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-105"></a><span>    </span><a href="Language.PlutusTx.Lift.Class.html#TypeableDep"><span class="hs-identifier hs-var">TypeableDep</span></a><span> </span><a name="local-6989586621679115986"><a href="#local-6989586621679115986"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#typeablePir"><span class="hs-identifier hs-var">typeablePir</span></a><span> </span><a href="#local-6989586621679115986"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-106"></a><span>    </span><a href="Language.PlutusTx.Lift.Class.html#LiftDep"><span class="hs-identifier hs-var">LiftDep</span></a><span> </span><a name="local-6989586621679115987"><a href="#local-6989586621679115987"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#liftPir"><span class="hs-identifier hs-var">liftPir</span></a><span> </span><a href="#local-6989586621679115987"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">getTyConDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#Deps"><span class="hs-identifier hs-type">Deps</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span>
</span><a name="line-109"></a><a name="getTyConDeps"><a href="Language.PlutusTx.Lift.Class.html#getTyConDeps"><span class="hs-identifier">getTyConDeps</span></a></a><span> </span><a name="local-6989586621679115988"><a href="#local-6989586621679115988"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621679115989"><span class="hs-identifier hs-var">typeableDep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679115988"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-111"></a><span>        </span><a name="local-6989586621679115989"><a href="#local-6989586621679115989"><span class="hs-identifier">typeableDep</span></a></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#TypeableDep"><span class="hs-identifier hs-var">TypeableDep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a name="local-6989586621679115990"><a href="#local-6989586621679115990"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679115990"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-112"></a><span>        </span><span class="hs-identifier">typeableDep</span><span> </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">addTypeableDep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115980"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115980"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><a name="addTypeableDep"><a href="Language.PlutusTx.Lift.Class.html#addTypeableDep"><span class="hs-identifier">addTypeableDep</span></a></a><span> </span><a name="local-6989586621679115991"><a href="#local-6989586621679115991"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#TypeableDep"><span class="hs-identifier hs-var">TypeableDep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#normalizeType"><span class="hs-identifier hs-var">normalizeType</span></a><span> </span><a href="#local-6989586621679115991"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">addLiftDep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115979"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115979"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><a name="addLiftDep"><a href="Language.PlutusTx.Lift.Class.html#addLiftDep"><span class="hs-identifier">addLiftDep</span></a></a><span> </span><a name="local-6989586621679115992"><a href="#local-6989586621679115992"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#LiftDep"><span class="hs-identifier hs-var">LiftDep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#normalizeType"><span class="hs-identifier hs-var">normalizeType</span></a><span> </span><a href="#local-6989586621679115992"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | The constraints when we are compiling at runtime. See note [Compiling at TH time and runtime].</span><span>
</span><a name="line-121"></a><span class="hs-keyword">type</span><span> </span><a name="RTCompiling"><a href="Language.PlutusTx.Lift.Class.html#RTCompiling"><span class="hs-identifier">RTCompiling</span></a></a><span> </span><a name="local-6989586621679111571"><a href="#local-6989586621679111571"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadDefs</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679111571"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadQuote</span><span> </span><a href="#local-6989586621679111571"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- | The constraints when we are compiling at TH time. See note [Compiling at TH time and runtime].</span><span>
</span><a name="line-123"></a><span class="hs-keyword">type</span><span> </span><a name="THCompiling"><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier">THCompiling</span></a></a><span> </span><a name="local-6989586621679111449"><a href="#local-6989586621679111449"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#Deps"><span class="hs-identifier hs-type">Deps</span></a><span> </span><a href="#local-6989586621679111449"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- See Note [Ordering of constructors]</span><span>
</span><a name="line-126"></a><span class="hs-identifier">sortedCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.DatatypeInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.ConstructorInfo</span><span class="hs-special">]</span><span>
</span><a name="line-127"></a><a name="sortedCons"><a href="Language.PlutusTx.Lift.Class.html#sortedCons"><span class="hs-identifier">sortedCons</span></a></a><span> </span><span class="hs-identifier hs-var">TH.DatatypeInfo</span><span class="hs-special">{</span><span class="hs-identifier">TH.datatypeName</span><span class="hs-glyph">=</span><a name="local-6989586621679115993"><a href="#local-6989586621679115993"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.datatypeCons</span><span class="hs-glyph">=</span><a name="local-6989586621679115994"><a href="#local-6989586621679115994"><span class="hs-identifier">cons</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-comment">-- We need to compare 'TH.Name's on their string name *not* on the unique</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679115995"><a href="#local-6989586621679115995"><span class="hs-identifier">sorted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">TH.constructorName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Name</span><span> </span><a name="local-6989586621679116146"><a href="#local-6989586621679116146"><span class="hs-identifier">o1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">TH.constructorName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Name</span><span> </span><a name="local-6989586621679116147"><a href="#local-6989586621679116147"><span class="hs-identifier">o2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621679116146"><span class="hs-identifier hs-var">o1</span></a><span> </span><a href="#local-6989586621679116147"><span class="hs-identifier hs-var">o2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679115994"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679115993"><span class="hs-identifier hs-var">tyName</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Bool</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679115993"><span class="hs-identifier hs-var">tyName</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">''</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679115995"><span class="hs-identifier hs-var">sorted</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679115995"><span class="hs-identifier hs-var">sorted</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-identifier">tvNameAndKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679115978"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115978"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><a name="tvNameAndKind"><a href="Language.PlutusTx.Lift.Class.html#tvNameAndKind"><span class="hs-identifier">tvNameAndKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-identifier hs-var">TH.SigT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarT</span><span> </span><a name="local-6989586621679116330"><a href="#local-6989586621679116330"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679116331"><a href="#local-6989586621679116331"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>        </span><a name="local-6989586621679116332"><a href="#local-6989586621679116332"><span class="hs-identifier">kind'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileKind"><span class="hs-identifier hs-var">compileKind</span></a><span> </span><a href="#local-6989586621679116331"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-136"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679116330"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679116332"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-string">&quot;Unknown sort of type variable&quot;</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- Types and kinds</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">{- Note [Type variables]
We handle types in almost exactly the same way when we are constructing Typeable
instances and when we are constructing Lift instances. However, there is one key difference
in how we handle type variables.

In the Typeable case, the type variables we see will be the type variables of the
datatype, which we want to map into the variable declarations that we construct. This requires
us to do some mapping between them at *runtime*, and keep a scope around to map between the TH names
and the PLC types.

In the Lift case, type variables will be free type variables in the instance, and should be handled
by appropriate Typeable constraints for those variables. We get the PLC types by just calling
typeRep.
-}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | A switch to indicate how to handle type variables. See note [Type variables].</span><span>
</span><a name="line-157"></a><span class="hs-keyword">data</span><span> </span><a name="VarsAs"><a href="Language.PlutusTx.Lift.Class.html#VarsAs"><span class="hs-identifier">VarsAs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Local"><a href="Language.PlutusTx.Lift.Class.html#Local"><span class="hs-identifier">Local</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Typeable"><a href="Language.PlutusTx.Lift.Class.html#Typeable"><span class="hs-identifier">Typeable</span></a></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">-- | A scope for type variables. See note [Type variables].</span><span>
</span><a name="line-160"></a><span class="hs-keyword">type</span><span> </span><a name="LocalVars"><a href="Language.PlutusTx.Lift.Class.html#LocalVars"><span class="hs-identifier">LocalVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">getLocalName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#LocalVars"><span class="hs-identifier hs-type">LocalVars</span></a><span> </span><a href="#local-6989586621679115977"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115977"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><a name="getLocalName"><a href="Language.PlutusTx.Lift.Class.html#getLocalName"><span class="hs-identifier">getLocalName</span></a></a><span> </span><a name="local-6989586621679116333"><a href="#local-6989586621679116333"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-164"></a><span>    </span><a name="local-6989586621679116334"><a href="#local-6989586621679116334"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679116333"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679116334"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679116335"><a href="#local-6989586621679116335"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116335"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-167"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Free type variable: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679116333"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">withTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#LocalVars"><span class="hs-identifier hs-type">LocalVars</span></a><span> </span><a href="#local-6989586621679115846"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyVarDecl</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115846"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679115847"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115846"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679115847"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-170"></a><a name="withTyVars"><a href="Language.PlutusTx.Lift.Class.html#withTyVars"><span class="hs-identifier">withTyVars</span></a></a><span> </span><a name="local-6989586621679116336"><a href="#local-6989586621679116336"><span class="hs-identifier">mappings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679116337"><a href="#local-6989586621679116337"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679116338"><a href="#local-6989586621679116338"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679116339"><a href="#local-6989586621679116339"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679116340"><a href="#local-6989586621679116340"><span class="hs-identifier">tvd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679116339"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116340"><span class="hs-identifier hs-var">tvd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116338"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116337"><span class="hs-identifier hs-var">scope</span></a><span> </span><a href="#local-6989586621679116336"><span class="hs-identifier hs-var">mappings</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-identifier">compileKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679115845"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115845"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><a name="compileKind"><a href="Language.PlutusTx.Lift.Class.html#compileKind"><span class="hs-identifier">compileKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-identifier hs-var">TH.StarT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier hs-var">TH.AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.AppT</span><span> </span><span class="hs-identifier hs-var">TH.ArrowT</span><span> </span><a name="local-6989586621679116341"><a href="#local-6989586621679116341"><span class="hs-identifier">k1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679116342"><a href="#local-6989586621679116342"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">KindArrow</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileKind"><span class="hs-identifier hs-var">compileKind</span></a><span> </span><a href="#local-6989586621679116341"><span class="hs-identifier hs-var">k1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileKind"><span class="hs-identifier hs-var">compileKind</span></a><span> </span><a href="#local-6989586621679116342"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621679116357"><a href="#local-6989586621679116357"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Unsupported kind: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679116357"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-comment">-- see note [Compiling at TH time and runtime]</span><span>
</span><a name="line-179"></a><span class="hs-identifier">compileType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115844"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#VarsAs"><span class="hs-identifier hs-type">VarsAs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115844"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><a name="compileType"><a href="Language.PlutusTx.Lift.Class.html#compileType"><span class="hs-identifier">compileType</span></a></a><span> </span><a name="local-6989586621679116358"><a href="#local-6989586621679116358"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-identifier hs-var">TH.AppT</span><span> </span><a name="local-6989586621679116359"><a href="#local-6989586621679116359"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621679116360"><a href="#local-6989586621679116360"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-182"></a><span>        </span><a name="local-6989586621679116361"><a href="#local-6989586621679116361"><span class="hs-identifier">t1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileType"><span class="hs-identifier hs-var">compileType</span></a><span> </span><a href="#local-6989586621679116358"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679116359"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-183"></a><span>        </span><a name="local-6989586621679116362"><a href="#local-6989586621679116362"><span class="hs-identifier">t2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileType"><span class="hs-identifier hs-var">compileType</span></a><span> </span><a href="#local-6989586621679116358"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679116360"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-184"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">TyApp</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679116361"><span class="hs-identifier hs-var">t1'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">$(</span><a href="#local-6989586621679116362"><span class="hs-identifier hs-var">t2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span>
</span><a name="line-185"></a><span>    </span><a name="local-6989586621679116365"><a href="#local-6989586621679116365"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a name="local-6989586621679116366"><a href="#local-6989586621679116366"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileTypeableType"><span class="hs-identifier hs-var">compileTypeableType</span></a><span> </span><a href="#local-6989586621679116365"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679116366"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-186"></a><span>    </span><span class="hs-comment">-- See note [Type variables]</span><span>
</span><a name="line-187"></a><span>    </span><a name="local-6989586621679116367"><a href="#local-6989586621679116367"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarT</span><span> </span><a name="local-6989586621679116368"><a href="#local-6989586621679116368"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679116358"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-188"></a><span>        </span><a href="Language.PlutusTx.Lift.Class.html#Typeable"><span class="hs-identifier hs-var">Typeable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileTypeableType"><span class="hs-identifier hs-var">compileTypeableType</span></a><span> </span><a href="#local-6989586621679116367"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679116368"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-189"></a><span>        </span><a href="Language.PlutusTx.Lift.Class.html#Local"><span class="hs-identifier hs-var">Local</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[|</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#getLocalName"><span class="hs-identifier hs-var">getLocalName</span></a><span> </span><a href="#local-6989586621679116368"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">|]</span><span>
</span><a name="line-190"></a><span>    </span><a name="local-6989586621679116369"><a href="#local-6989586621679116369"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Unsupported type: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679116369"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- | Compile a type with the given name using 'typeRep' and incurring a corresponding 'Typeable' dependency.</span><span>
</span><a name="line-193"></a><span class="hs-identifier">compileTypeableType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115843"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115843"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><a name="compileTypeableType"><a href="Language.PlutusTx.Lift.Class.html#compileTypeableType"><span class="hs-identifier">compileTypeableType</span></a></a><span> </span><a name="local-6989586621679116370"><a href="#local-6989586621679116370"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679116371"><a href="#local-6989586621679116371"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-195"></a><span>    </span><a href="Language.PlutusTx.Lift.Class.html#addTypeableDep"><span class="hs-identifier hs-var">addTypeableDep</span></a><span> </span><a href="#local-6989586621679116370"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[|</span><span>
</span><a name="line-197"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-198"></a><span>              </span><a name="local-6989586621679116372"><a href="#local-6989586621679116372"><span class="hs-identifier">maybeType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupType</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116371"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-199"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679116372"><span class="hs-identifier hs-var">maybeType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-200"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679116373"><a href="#local-6989586621679116373"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116373"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-201"></a><span>                  </span><span class="hs-comment">-- this will need some additional constraints in scope</span><span>
</span><a name="line-202"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#typeRep"><span class="hs-identifier hs-var">typeRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116370"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-special">|]</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- Typeable</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- TODO: try and make this work with type applications</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- | Class for types which have a corresponding Plutus IR type. Instances should usually be declared</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- for type constructors, instances for applied types will be derived.</span><span>
</span><a name="line-210"></a><span class="hs-keyword">class</span><span> </span><a name="Typeable"><a href="Language.PlutusTx.Lift.Class.html#Typeable"><span class="hs-identifier">Typeable</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679110633"><a href="#local-6989586621679110633"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679110632"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-211"></a><span>    </span><span class="hs-comment">-- | Get the Plutus IR type corresponding to this type.</span><span>
</span><a name="line-212"></a><span>    </span><a name="typeRep"><a href="Language.PlutusTx.Lift.Class.html#typeRep"><span class="hs-identifier">typeRep</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#RTCompiling"><span class="hs-identifier hs-type">RTCompiling</span></a><span> </span><a href="#local-6989586621679110634"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679110633"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679110634"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">compileTypeRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115842"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.DatatypeInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115842"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><a name="compileTypeRep"><a href="Language.PlutusTx.Lift.Class.html#compileTypeRep"><span class="hs-identifier">compileTypeRep</span></a></a><span> </span><a name="local-6989586621679116389"><a href="#local-6989586621679116389"><span class="hs-identifier">dt</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">TH.DatatypeInfo</span><span class="hs-special">{</span><span class="hs-identifier">TH.datatypeName</span><span class="hs-glyph">=</span><a name="local-6989586621679116390"><a href="#local-6989586621679116390"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.datatypeVars</span><span class="hs-glyph">=</span><a name="local-6989586621679116391"><a href="#local-6989586621679116391"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">}</span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621679116392"><a href="#local-6989586621679116392"><span class="hs-identifier">tvNamesAndKinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#tvNameAndKind"><span class="hs-identifier hs-var">tvNameAndKind</span></a><span> </span><a href="#local-6989586621679116391"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-217"></a><span>    </span><span class="hs-comment">-- annoyingly th-abstraction doesn't give us a kind we can compile here</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116393"><a href="#local-6989586621679116393"><span class="hs-identifier">datatypeKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679116394"><a href="#local-6989586621679116394"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679116395"><a href="#local-6989586621679116395"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">KindArrow</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116394"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679116395"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116392"><span class="hs-identifier hs-var">tvNamesAndKinds</span></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679116396"><a href="#local-6989586621679116396"><span class="hs-identifier">constrExprs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#compileConstructorDecl"><span class="hs-identifier hs-var">compileConstructorDecl</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#sortedCons"><span class="hs-identifier hs-var">sortedCons</span></a><span> </span><a href="#local-6989586621679116389"><span class="hs-identifier hs-var">dt</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621679116397"><a href="#local-6989586621679116397"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#getTyConDeps"><span class="hs-identifier hs-var">getTyConDeps</span></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-comment">-- see note [Compiling at TH time and runtime]</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[|</span><span>
</span><a name="line-224"></a><span>          </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>              </span><span class="hs-comment">-- TODO: this is essentially the same as the code in Type.hs, really unify them</span><span>
</span><a name="line-226"></a><span>              </span><a name="local-6989586621679116398"><a href="#local-6989586621679116398"><span class="hs-identifier">maybeDefined</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupType</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116390"><span class="hs-identifier hs-var">tyName</span></a><span>
</span><a name="line-227"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679116398"><span class="hs-identifier hs-var">maybeDefined</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-228"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679116399"><a href="#local-6989586621679116399"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116399"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-229"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679116400"><a href="#local-6989586621679116400"><span class="hs-identifier">dtvd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#mkTyVarDecl"><span class="hs-identifier hs-var">mkTyVarDecl</span></a><span> </span><a href="#local-6989586621679116390"><span class="hs-identifier hs-var">tyName</span></a><span> </span><a href="#local-6989586621679116393"><span class="hs-identifier hs-var">datatypeKind</span></a><span>
</span><a name="line-231"></a><span>                      </span><a name="local-6989586621679116416"><a href="#local-6989586621679116416"><span class="hs-identifier">tvds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#mkTyVarDecl"><span class="hs-identifier hs-var">mkTyVarDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116392"><span class="hs-identifier hs-var">tvNamesAndKinds</span></a><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span>                      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116417"><a href="#local-6989586621679116417"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIterTyApp</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116416"><span class="hs-identifier hs-var">tvds</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>                      </span><a name="local-6989586621679116418"><a href="#local-6989586621679116418"><span class="hs-identifier">matchName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">safeFreshName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-string">&quot;match_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#showName"><span class="hs-identifier hs-var">showName</span></a><span> </span><a href="#local-6989586621679116390"><span class="hs-identifier hs-var">tyName</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>                      </span><span class="hs-comment">-- Define it so we get something for recursive uses</span><span>
</span><a name="line-237"></a><span>                      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116419"><a href="#local-6989586621679116419"><span class="hs-identifier">fakeDatatype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Datatype</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679116418"><span class="hs-identifier hs-var">matchName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>                      </span><span class="hs-identifier hs-var">defineDatatype</span><span> </span><a href="#local-6989586621679116390"><span class="hs-identifier hs-var">tyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.Def</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span> </span><a href="#local-6989586621679116419"><span class="hs-identifier hs-var">fakeDatatype</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>                      </span><a href="Language.PlutusTx.Lift.Class.html#withTyVars"><span class="hs-identifier hs-var">withTyVars</span></a><span> </span><a href="#local-6989586621679116416"><span class="hs-identifier hs-var">tvds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-242"></a><span>                          </span><span class="hs-comment">-- The TH expressions are in fact all functions that take the result type, so</span><span>
</span><a name="line-243"></a><span>                          </span><span class="hs-comment">-- we need to apply them</span><span>
</span><a name="line-244"></a><span>                          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116420"><a href="#local-6989586621679116420"><span class="hs-identifier">constrActs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.listE</span><span> </span><a href="#local-6989586621679116396"><span class="hs-identifier hs-var">constrExprs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679116417"><span class="hs-identifier hs-var">resultType</span></a><span class="hs-special">]</span><span>
</span><a name="line-245"></a><span>                          </span><a name="local-6989586621679116422"><a href="#local-6989586621679116422"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621679116420"><span class="hs-identifier hs-var">constrActs</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>                          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116423"><a href="#local-6989586621679116423"><span class="hs-identifier">datatype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Datatype</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679116416"><span class="hs-identifier hs-var">tvds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116418"><span class="hs-identifier hs-var">matchName</span></a><span> </span><a href="#local-6989586621679116422"><span class="hs-identifier hs-var">constrs</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>                          </span><span class="hs-identifier hs-var">defineDatatype</span><span> </span><a href="#local-6989586621679116390"><span class="hs-identifier hs-var">tyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PLC.Def</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span> </span><a href="#local-6989586621679116423"><span class="hs-identifier hs-var">datatype</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116397"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>                      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116400"><span class="hs-identifier hs-var">dtvd</span></a><span>
</span><a name="line-252"></a><span>          </span><span class="hs-special">|]</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-identifier">compileConstructorDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115841"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.ConstructorInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115841"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><a name="compileConstructorDecl"><a href="Language.PlutusTx.Lift.Class.html#compileConstructorDecl"><span class="hs-identifier">compileConstructorDecl</span></a></a><span> </span><span class="hs-identifier hs-var">TH.ConstructorInfo</span><span class="hs-special">{</span><span class="hs-identifier">TH.constructorName</span><span class="hs-glyph">=</span><a name="local-6989586621679116424"><a href="#local-6989586621679116424"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.constructorFields</span><span class="hs-glyph">=</span><a name="local-6989586621679116425"><a href="#local-6989586621679116425"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-256"></a><span>    </span><a name="local-6989586621679116426"><a href="#local-6989586621679116426"><span class="hs-identifier">tyExprs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#compileType"><span class="hs-identifier hs-var">compileType</span></a><span> </span><a href="Language.PlutusTx.Lift.Class.html#Local"><span class="hs-identifier hs-var">Local</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#normalizeType"><span class="hs-identifier hs-var">normalizeType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116425"><span class="hs-identifier hs-var">argTys</span></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- see note [Compiling at TH time and runtime]</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[|</span><span>
</span><a name="line-259"></a><span>          </span><span class="hs-comment">-- we won't know the result type until runtime, so take it as an argument</span><span>
</span><a name="line-260"></a><span>          </span><span class="hs-glyph">\</span><a name="local-6989586621679116427"><a href="#local-6989586621679116427"><span class="hs-identifier">resultType</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>              </span><a name="local-6989586621679116429"><a href="#local-6989586621679116429"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.listE</span><span> </span><a href="#local-6989586621679116426"><span class="hs-identifier hs-var">tyExprs</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116430"><a href="#local-6989586621679116430"><span class="hs-identifier">constrTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIterTyFun</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116429"><span class="hs-identifier hs-var">tys'</span></a><span> </span><a href="#local-6989586621679116427"><span class="hs-identifier hs-var">resultType</span></a><span>
</span><a name="line-263"></a><span>              </span><a name="local-6989586621679116431"><a href="#local-6989586621679116431"><span class="hs-identifier">constrName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">safeFreshName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#showName"><span class="hs-identifier hs-var">showName</span></a><span> </span><a href="#local-6989586621679116424"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-264"></a><span>              </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">VarDecl</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116431"><span class="hs-identifier hs-var">constrName</span></a><span> </span><a href="#local-6989586621679116430"><span class="hs-identifier hs-var">constrTy</span></a><span>
</span><a name="line-265"></a><span>          </span><span class="hs-special">|]</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-identifier">makeTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-268"></a><a name="makeTypeable"><a href="Language.PlutusTx.Lift.Class.html#makeTypeable"><span class="hs-identifier">makeTypeable</span></a></a><span> </span><a name="local-6989586621679116432"><a href="#local-6989586621679116432"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-269"></a><span>    </span><a href="Language.PlutusTx.Lift.THUtils.html#requireExtension"><span class="hs-identifier hs-var">requireExtension</span></a><span> </span><span class="hs-identifier hs-var">TH.ScopedTypeVariables</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>    </span><a name="local-6989586621679116433"><a href="#local-6989586621679116433"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.reifyDatatype</span><span> </span><a href="#local-6989586621679116432"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-272"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679116434"><a href="#local-6989586621679116434"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679116435"><a href="#local-6989586621679116435"><span class="hs-identifier">deps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runState</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#compileTypeRep"><span class="hs-identifier hs-var">compileTypeRep</span></a><span> </span><a href="#local-6989586621679116433"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-comment">-- See Note [Closed constraints]</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116436"><a href="#local-6989586621679116436"><span class="hs-identifier">constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#isClosedConstraint"><span class="hs-identifier hs-var">isClosedConstraint</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#toConstraint"><span class="hs-identifier hs-var">toConstraint</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679116435"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span>    </span><a name="local-6989586621679116437"><a href="#local-6989586621679116437"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.funD</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">typeRep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.clause</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.wildP</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.normalB</span><span> </span><a href="#local-6989586621679116434"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.InstanceD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679116436"><span class="hs-identifier hs-var">constraints</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#typeablePir"><span class="hs-identifier hs-var">typeablePir</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a href="#local-6989586621679116432"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679116437"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-comment">-- Lift</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">-- | Class for types which can be lifted into Plutus IR.</span><span>
</span><a name="line-283"></a><span class="hs-keyword">class</span><span> </span><a name="Lift"><a href="Language.PlutusTx.Lift.Class.html#Lift"><span class="hs-identifier">Lift</span></a></a><span> </span><a name="local-6989586621679110630"><a href="#local-6989586621679110630"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">-- | Get a Plutus IR term corresponding to the given value.</span><span>
</span><a name="line-285"></a><span>    </span><a name="lift"><a href="Language.PlutusTx.Lift.Class.html#lift"><span class="hs-identifier">lift</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#RTCompiling"><span class="hs-identifier hs-type">RTCompiling</span></a><span> </span><a href="#local-6989586621679110631"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679110630"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679110631"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Term</span><span> </span><span class="hs-identifier hs-type">TyName</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">compileLift</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115840"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.DatatypeInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115840"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Clause</span><span class="hs-special">]</span><span>
</span><a name="line-288"></a><a name="compileLift"><a href="Language.PlutusTx.Lift.Class.html#compileLift"><span class="hs-identifier">compileLift</span></a></a><span> </span><a name="local-6989586621679116438"><a href="#local-6989586621679116438"><span class="hs-identifier">dt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#compileConstructorClause"><span class="hs-identifier hs-var">compileConstructorClause</span></a><span> </span><a href="#local-6989586621679116438"><span class="hs-identifier hs-var">dt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#sortedCons"><span class="hs-identifier hs-var">sortedCons</span></a><span> </span><a href="#local-6989586621679116438"><span class="hs-identifier hs-var">dt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-identifier">compileConstructorClause</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#THCompiling"><span class="hs-identifier hs-type">THCompiling</span></a><span> </span><a href="#local-6989586621679115839"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.DatatypeInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.ConstructorInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679115839"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Clause</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><a name="compileConstructorClause"><a href="Language.PlutusTx.Lift.Class.html#compileConstructorClause"><span class="hs-identifier">compileConstructorClause</span></a></a><span> </span><span class="hs-identifier hs-var">TH.DatatypeInfo</span><span class="hs-special">{</span><span class="hs-identifier">TH.datatypeName</span><span class="hs-glyph">=</span><a name="local-6989586621679116439"><a href="#local-6989586621679116439"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.datatypeVars</span><span class="hs-glyph">=</span><a name="local-6989586621679116440"><a href="#local-6989586621679116440"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679116441"><a href="#local-6989586621679116441"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-identifier hs-var">TH.ConstructorInfo</span><span class="hs-special">{</span><span class="hs-identifier">TH.constructorName</span><span class="hs-glyph">=</span><a name="local-6989586621679116442"><a href="#local-6989586621679116442"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.constructorFields</span><span class="hs-glyph">=</span><a name="local-6989586621679116443"><a href="#local-6989586621679116443"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">-- need to be able to lift the argument types</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-identifier hs-var">traverse_</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#addLiftDep"><span class="hs-identifier hs-var">addLiftDep</span></a><span> </span><a href="#local-6989586621679116443"><span class="hs-identifier hs-var">argTys</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span>    </span><span class="hs-comment">-- need the actual type parameters</span><span>
</span><a name="line-296"></a><span>    </span><a name="local-6989586621679116444"><a href="#local-6989586621679116444"><span class="hs-identifier">typeExprs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#compileType"><span class="hs-identifier hs-var">compileType</span></a><span> </span><a href="Language.PlutusTx.Lift.Class.html#Typeable"><span class="hs-identifier hs-var">Typeable</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusTx.Lift.THUtils.html#normalizeType"><span class="hs-identifier hs-var">normalizeType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116440"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-297"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-298"></a><span>        </span><a name="local-6989586621679116445"><a href="#local-6989586621679116445"><span class="hs-identifier">patNames</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679116443"><span class="hs-identifier hs-var">argTys</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">TH.newName</span><span> </span><span class="hs-string">&quot;arg&quot;</span><span>
</span><a name="line-299"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116446"><a href="#local-6989586621679116446"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">TH.varP</span><span> </span><a href="#local-6989586621679116445"><span class="hs-identifier hs-var">patNames</span></a><span>
</span><a name="line-300"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116447"><a href="#local-6989586621679116447"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.conP</span><span> </span><a href="#local-6989586621679116442"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679116446"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-301"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116448"><a href="#local-6989586621679116448"><span class="hs-identifier">liftExprs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679116449"><a href="#local-6989586621679116449"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">TH.varE</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">lift</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TH.appE</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">TH.varE</span><span> </span><a href="#local-6989586621679116449"><span class="hs-identifier hs-var">pn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116445"><span class="hs-identifier hs-var">patNames</span></a><span>
</span><a name="line-302"></a><span>        </span><span class="hs-comment">-- see note [Compiling at TH time and runtime]</span><span>
</span><a name="line-303"></a><span>        </span><a name="local-6989586621679116459"><a href="#local-6989586621679116459"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-304"></a><span>            </span><span class="hs-special">[|</span><span>
</span><a name="line-305"></a><span>              </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>                  </span><span class="hs-comment">-- force creation of datatype</span><span>
</span><a name="line-307"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#typeRep"><span class="hs-identifier hs-var">typeRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.conT</span><span> </span><a href="#local-6989586621679116439"><span class="hs-identifier hs-var">tyName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>                  </span><span class="hs-comment">-- get the right constructor</span><span>
</span><a name="line-310"></a><span>                  </span><a name="local-6989586621679116451"><a href="#local-6989586621679116451"><span class="hs-identifier">maybeConstructors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupConstructors</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116439"><span class="hs-identifier hs-var">tyName</span></a><span>
</span><a name="line-311"></a><span>                  </span><a name="local-6989586621679116453"><a href="#local-6989586621679116453"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679116451"><span class="hs-identifier hs-var">maybeConstructors</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-312"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#die"><span class="hs-identifier hs-var">die</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Constructors not created for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679116439"><span class="hs-identifier hs-var">tyName</span></a><span>
</span><a name="line-313"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679116452"><a href="#local-6989586621679116452"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116452"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-314"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116454"><a href="#local-6989586621679116454"><span class="hs-identifier">constr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679116453"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621679116441"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>                  </span><span class="hs-comment">-- need to instantiate it to the right types and then lift all the arguments and apply it to them</span><span>
</span><a name="line-317"></a><span>                  </span><a name="local-6989586621679116456"><a href="#local-6989586621679116456"><span class="hs-identifier">types</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.listE</span><span> </span><a href="#local-6989586621679116444"><span class="hs-identifier hs-var">typeExprs</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>                  </span><a name="local-6989586621679116458"><a href="#local-6989586621679116458"><span class="hs-identifier">lifts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">TH.listE</span><span> </span><a href="#local-6989586621679116448"><span class="hs-identifier hs-var">liftExprs</span></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>                  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkIterApp</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIterInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116454"><span class="hs-identifier hs-var">constr</span></a><span> </span><a href="#local-6989586621679116456"><span class="hs-identifier hs-var">types</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116458"><span class="hs-identifier hs-var">lifts</span></a><span>
</span><a name="line-321"></a><span>            </span><span class="hs-special">|]</span><span>
</span><a name="line-322"></a><span>        </span><span class="hs-identifier hs-var">TH.clause</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679116447"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.normalB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679116459"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">makeLift</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-325"></a><a name="makeLift"><a href="Language.PlutusTx.Lift.Class.html#makeLift"><span class="hs-identifier">makeLift</span></a></a><span> </span><a name="local-6989586621679116460"><a href="#local-6989586621679116460"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-326"></a><span>    </span><a href="Language.PlutusTx.Lift.THUtils.html#requireExtension"><span class="hs-identifier hs-var">requireExtension</span></a><span> </span><span class="hs-identifier hs-var">TH.ScopedTypeVariables</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-comment">-- we need this too if we're lifting</span><span>
</span><a name="line-329"></a><span>    </span><a name="local-6989586621679116461"><a href="#local-6989586621679116461"><span class="hs-identifier">typeableDecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#makeTypeable"><span class="hs-identifier hs-var">makeTypeable</span></a><span> </span><a href="#local-6989586621679116460"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-330"></a><span>    </span><a name="local-6989586621679116462"><a href="#local-6989586621679116462"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.reifyDatatype</span><span> </span><a href="#local-6989586621679116460"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116463"><a href="#local-6989586621679116463"><span class="hs-identifier">datatypeType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.datatypeType</span><span> </span><a href="#local-6989586621679116462"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679116464"><a href="#local-6989586621679116464"><span class="hs-identifier">clauses</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679116465"><a href="#local-6989586621679116465"><span class="hs-identifier">deps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runState</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#compileLift"><span class="hs-identifier hs-var">compileLift</span></a><span> </span><a href="#local-6989586621679116462"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>    </span><span class="hs-comment">{-
    Here we *do* need to add some constraints, because we're going to generate things like
    `instance Lift a =&gt; Lift (Maybe a)`. We can't just leave these open because they refer to type variables.

    We *could* put in a Typeable constraint for the type itself. This is somewhat more correct,
    but GHC warns us if we do this because we always also define the instance alongside. So we just
    leave it out.

    We also need to remove any Lift constraints we get for the type we're defining. This can happen if
    we're recursive, since we'll probably end up with constructor arguments of the current type.
    We don't want `instance Lift [a] =&gt; Lift [a]`!
    -}</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116466"><a href="#local-6989586621679116466"><span class="hs-identifier">prunedDeps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#LiftDep"><span class="hs-identifier hs-var">LiftDep</span></a><span> </span><a href="#local-6989586621679116463"><span class="hs-identifier hs-var">datatypeType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679116465"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-349"></a><span>    </span><span class="hs-comment">-- See Note [Closed constraints]</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116467"><a href="#local-6989586621679116467"><span class="hs-identifier">constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#isClosedConstraint"><span class="hs-identifier hs-var">isClosedConstraint</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Lift.Class.html#toConstraint"><span class="hs-identifier hs-var">toConstraint</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679116466"><span class="hs-identifier hs-var">prunedDeps</span></a><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>    </span><a name="local-6989586621679116468"><a href="#local-6989586621679116468"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.funD</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">lift</span><span> </span><a href="#local-6989586621679116464"><span class="hs-identifier hs-var">clauses</span></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679116469"><a href="#local-6989586621679116469"><span class="hs-identifier">liftDecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.InstanceD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679116467"><span class="hs-identifier hs-var">constraints</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Lift.Class.html#liftPir"><span class="hs-identifier hs-var">liftPir</span></a><span> </span><a href="#local-6989586621679116463"><span class="hs-identifier hs-var">datatypeType</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679116468"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-354"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679116461"><span class="hs-identifier hs-var">typeableDecs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679116469"><span class="hs-identifier hs-var">liftDecs</span></a><span>
</span><a name="line-355"></a></pre></body></html>