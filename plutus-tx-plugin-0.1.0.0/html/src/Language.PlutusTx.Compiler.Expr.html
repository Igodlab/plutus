<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns      #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">-- | Functions for compiling GHC Core expressions into Plutus Core terms.</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.PlutusTx.Compiler.Expr</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExprWithDefs"><span class="hs-identifier hs-var">convExprWithDefs</span></a><span class="hs-special">,</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convDataConRef"><span class="hs-identifier hs-var">convDataConRef</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">PlutusPrelude</span><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bsToStr</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Binders.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Binders</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Builtins.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Builtins</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Error.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Error</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Laziness.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Laziness</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Names.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Names</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Primitives.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Primitives</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Type.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Type</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Types.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Types</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Compiler.Utils.html"><span class="hs-identifier">Language.PlutusTx.Compiler.Utils</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.PIRTypes.html"><span class="hs-identifier">Language.PlutusTx.PIRTypes</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Language.PlutusTx.Utils.html"><span class="hs-identifier">Language.PlutusTx.Utils</span></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">CoreUtils</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GhcPlugins</span><span>                             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">MkId</span><span>                                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">PrelNames</span><span>                              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR.Compiler.Definitions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language.PlutusIR.Compiler.Names</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR.MkPir</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusIR.Value</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PIR</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.PlutusCore.Constant</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PLC</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSL</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">elemIndex</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List.NonEmpty</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">{- Note [System FC and System FW]
Haskell uses system FC, which includes type equalities and coercions.

PLC does *not* have coercions in particular. However, PLC also does not have a nominal
type system - everything is constructed via operators on base types, so we have no
need for coercions to convert between newtypes and datatypes.

So we mostly ignore coercions. The one place that I know of where the mismatch hurts
us is that GHC uses the `Any` type (coercible to and from anything) for unconstrained
function variables, e.g. in polymorphic lambdas. This is annoying for us, since we
really want the version with explicit type abstraction. I don't currently have a fix
for this.
-}</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- Literals and primitives</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">{- Note [Literals]
GHC's literals and primitives are a bit of a pain, since they not only have a Literal
containing the actual data, but are wrapped in special functions (often ending in the magic #).

This is a pain to recognize.
-}</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-identifier">convLiteral</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679353413"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.Literal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679353413"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-70"></a><a name="convLiteral"><a href="Language.PlutusTx.Compiler.Expr.html#convLiteral"><span class="hs-identifier">convLiteral</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">-- TODO: better sizes</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachInt64</span><span> </span><a name="local-6989586621679353414"><a href="#local-6989586621679353414"><span class="hs-identifier">i</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Constant</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PLC.BuiltinInt</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Utils.html#haskellIntSize"><span class="hs-identifier hs-var">haskellIntSize</span></a><span> </span><a href="#local-6989586621679353414"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachInt</span><span> </span><a name="local-6989586621679353415"><a href="#local-6989586621679353415"><span class="hs-identifier">i</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Constant</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PLC.BuiltinInt</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="Language.PlutusTx.Utils.html#haskellIntSize"><span class="hs-identifier hs-var">haskellIntSize</span></a><span> </span><a href="#local-6989586621679353415"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachStr</span><span> </span><a name="local-6989586621679353416"><a href="#local-6989586621679353416"><span class="hs-identifier">bs</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- Convert the bytestring into a core expression representing the list</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- of characters, then compile that!</span><span>
</span><a name="line-77"></a><span>        </span><span class="hs-comment">-- Note that we do *not* convert this into a PLC string, but rather a list of characters,</span><span>
</span><a name="line-78"></a><span>        </span><span class="hs-comment">-- since that is what other Haskell code will expect.</span><span>
</span><a name="line-79"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-80"></a><span>            </span><a name="local-6989586621679353417"><a href="#local-6989586621679353417"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bsToStr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BSL.fromStrict</span><span> </span><a href="#local-6989586621679353416"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>            </span><a name="local-6989586621679353418"><a href="#local-6989586621679353418"><span class="hs-identifier">charExprs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">GHC.mkCharExpr</span><span> </span><a href="#local-6989586621679353417"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-82"></a><span>            </span><a name="local-6989586621679353419"><a href="#local-6989586621679353419"><span class="hs-identifier">listExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.mkListExpr</span><span> </span><span class="hs-identifier hs-var">GHC.charTy</span><span> </span><a href="#local-6989586621679353418"><span class="hs-identifier hs-var">charExprs</span></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679353419"><span class="hs-identifier hs-var">listExpr</span></a><span>
</span><a name="line-84"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachChar</span><span> </span><a name="local-6989586621679353612"><a href="#local-6989586621679353612"><span class="hs-identifier">c</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>        </span><a name="local-6989586621679353613"><a href="#local-6989586621679353613"><span class="hs-identifier">maybeEncoded</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PLC.liftQuote</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PLC.makeDynamicBuiltin</span><span> </span><a href="#local-6989586621679353612"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-86"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679353613"><span class="hs-identifier hs-var">maybeEncoded</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-87"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679353614"><a href="#local-6989586621679353614"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.embedIntoIR</span><span> </span><a href="#local-6989586621679353614"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-88"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Conversion of character failed&quot;</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-identifier hs-var">GHC.LitInteger</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal (unbounded) integer&quot;</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachWord</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal word&quot;</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachWord64</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal word64&quot;</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachFloat</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal float&quot;</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachDouble</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal double&quot;</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachLabel</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal label&quot;</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-identifier hs-var">GHC.MachNullAddr</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Literal null&quot;</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-identifier">isPrimitiveWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-98"></a><a name="isPrimitiveWrapper"><a href="Language.PlutusTx.Compiler.Expr.html#isPrimitiveWrapper"><span class="hs-identifier">isPrimitiveWrapper</span></a></a><span> </span><a name="local-6989586621679353615"><a href="#local-6989586621679353615"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><a href="#local-6989586621679353615"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-identifier hs-var">GHC.DataConWorkId</span><span> </span><a name="local-6989586621679354080"><a href="#local-6989586621679354080"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#isPrimitiveDataCon"><span class="hs-identifier hs-var">isPrimitiveDataCon</span></a><span> </span><a href="#local-6989586621679354080"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">GHC.VanillaId</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679353615"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.unpackCStringName</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-identifier">isPrimitiveDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-104"></a><a name="isPrimitiveDataCon"><a href="Language.PlutusTx.Compiler.Expr.html#isPrimitiveDataCon"><span class="hs-identifier">isPrimitiveDataCon</span></a></a><span> </span><a name="local-6989586621679354081"><a href="#local-6989586621679354081"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679354081"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.intDataCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679354081"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.charDataCon</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">-- | Convert a reference to a data constructor, i.e. a call to it.</span><span>
</span><a name="line-107"></a><span class="hs-identifier">convDataConRef</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679353412"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679353412"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-108"></a><a name="convDataConRef"><a href="Language.PlutusTx.Compiler.Expr.html#convDataConRef"><span class="hs-identifier">convDataConRef</span></a></a><span> </span><a name="local-6989586621679354082"><a href="#local-6989586621679354082"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-110"></a><span>        </span><a name="local-6989586621679354083"><a href="#local-6989586621679354083"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.dataConTyCon</span><span> </span><a href="#local-6989586621679354082"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>        </span><a name="local-6989586621679354084"><a href="#local-6989586621679354084"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier hs-var">getDataCons</span></a><span> </span><a href="#local-6989586621679354083"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-113"></a><span>        </span><a name="local-6989586621679354085"><a href="#local-6989586621679354085"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getConstructors"><span class="hs-identifier hs-var">getConstructors</span></a><span> </span><a href="#local-6989586621679354083"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>        </span><span class="hs-comment">-- TODO: this is inelegant</span><span>
</span><a name="line-116"></a><span>        </span><a name="local-6989586621679354087"><a href="#local-6989586621679354087"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">elemIndex</span><span> </span><a href="#local-6989586621679354082"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621679354084"><span class="hs-identifier hs-var">dcs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-117"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679354086"><a href="#local-6989586621679354086"><span class="hs-identifier">i</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679354086"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-118"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Data constructor not in the type constructor's list of constructors!&quot;</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679354085"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621679354087"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">isErrorId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-123"></a><a name="isErrorId"><a href="Language.PlutusTx.Compiler.Expr.html#isErrorId"><span class="hs-identifier">isErrorId</span></a></a><span> </span><a name="local-6989586621679354088"><a href="#local-6989586621679354088"><span class="hs-identifier">ghcId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679354088"><span class="hs-identifier hs-var">ghcId</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">GHC.errorIds</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">{- Note [GHC runtime errors]
GHC has a number of runtime errors for things like pattern matching failures and so on.

We just translate these directly into calls to error, throwing away any other information.

Annoyingly, unlike void, we can't mangle the type uniformly to make sure we are safe
with respect to the value restriction (see note [Value restriction]), so we just have to force
our error call and hope that it doesn't end up somewhere it shouldn't.
-}</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">{- Note [At patterns]
GHC handles @-patterns by adding a variable to each case expression representing the scrutinee
of the expression.

We handle this by simply let-binding that variable outside our generated case. In the instances
where it's not used, the PIR dead-binding pass will remove it.
-}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- Expressions</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">convExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679353411"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679353411"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-146"></a><a name="convExpr"><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier">convExpr</span></a></a><span> </span><a name="local-6989586621679354089"><a href="#local-6989586621679354089"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Converting expr:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679354089"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-comment">-- See Note [Scopes]</span><span>
</span><a name="line-148"></a><span>    </span><a href="Language.PlutusTx.Compiler.Types.html#ConvertingContext"><span class="hs-identifier hs-var">ConvertingContext</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ccScopes</span><span class="hs-glyph">=</span><a name="local-6989586621679354090"><a href="#local-6989586621679354090"><span class="hs-identifier">stack</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354091"><a href="#local-6989586621679354091"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NE.head</span><span> </span><a href="#local-6989586621679354090"><span class="hs-identifier hs-var">stack</span></a><span>
</span><a name="line-150"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679354089"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-comment">-- See Note [Literals]</span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-identifier hs-var">GHC.App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Expr.html#isPrimitiveWrapper"><span class="hs-identifier hs-var">isPrimitiveWrapper</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679354092"><a href="#local-6989586621679354092"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354092"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-153"></a><span>        </span><span class="hs-comment">-- special typeclass method calls</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-identifier hs-var">GHC.App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.App</span><span>
</span><a name="line-155"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><a name="local-6989586621679354093"><a href="#local-6989586621679354093"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ClassOpId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621679354094"><a href="#local-6989586621679354094"><span class="hs-identifier">className</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>                </span><span class="hs-comment">-- we only support applying to int</span><span>
</span><a name="line-157"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.eqType</span><span> </span><span class="hs-identifier hs-var">GHC.intTy</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>            </span><span class="hs-comment">-- last arg is typeclass dictionary</span><span>
</span><a name="line-159"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679354094"><span class="hs-identifier hs-var">className</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-160"></a><span>                     </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GHC.eqClassName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Primitives.html#convEqMethod"><span class="hs-identifier hs-var">convEqMethod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679354093"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                     </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GHC.ordClassName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Primitives.html#convOrdMethod"><span class="hs-identifier hs-var">convOrdMethod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679354093"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>                     </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GHC.numClassName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Primitives.html#convNumMethod"><span class="hs-identifier hs-var">convNumMethod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679354093"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>                     </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GHC.integralClassName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Primitives.html#convIntegralMethod"><span class="hs-identifier hs-var">convIntegralMethod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679354093"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>                     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Typeclass method:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679354093"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-165"></a><span>        </span><span class="hs-comment">-- void# - values of type void get represented as error, since they should be unreachable</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><a name="local-6989586621679354095"><a href="#local-6989586621679354095"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679354095"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.voidPrimId</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679354095"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">GHC.voidArgId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Builtins.html#errorFunc"><span class="hs-identifier hs-var">errorFunc</span></a><span>
</span><a name="line-167"></a><span>        </span><span class="hs-comment">-- See note [GHC runtime errors]</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-identifier hs-var">GHC.App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.App</span><span>
</span><a name="line-169"></a><span>                </span><span class="hs-comment">-- error function</span><span>
</span><a name="line-170"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Expr.html#isErrorId"><span class="hs-identifier hs-var">isErrorId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>                </span><span class="hs-comment">-- runtime rep</span><span>
</span><a name="line-172"></a><span>                </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>                </span><span class="hs-comment">-- type of overall expression</span><span>
</span><a name="line-174"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Type</span><span> </span><a name="local-6989586621679354096"><a href="#local-6989586621679354096"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Laziness.html#force"><span class="hs-identifier hs-var">force</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">PIR.TyInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Builtins.html#errorFunc"><span class="hs-identifier hs-var">errorFunc</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679354096"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-176"></a><span>        </span><span class="hs-comment">-- locally bound vars</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Names.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a><span> </span><a href="#local-6989586621679354091"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.VarDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679354097"><a href="#local-6989586621679354097"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Var</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354097"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-178"></a><span>        </span><span class="hs-comment">-- Special kinds of id</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.PrimOpId</span><span> </span><a name="local-6989586621679354098"><a href="#local-6989586621679354098"><span class="hs-identifier">po</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Primitives.html#convPrimitiveOp"><span class="hs-identifier hs-var">convPrimitiveOp</span></a><span> </span><a href="#local-6989586621679354098"><span class="hs-identifier hs-var">po</span></a><span>
</span><a name="line-180"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.DataConWorkId</span><span> </span><a name="local-6989586621679354099"><a href="#local-6989586621679354099"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convDataConRef"><span class="hs-identifier hs-var">convDataConRef</span></a><span> </span><a href="#local-6989586621679354099"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-181"></a><span>        </span><span class="hs-comment">-- TODO: support record selectors. AFAICT GHC doesn't make a pattern-matching function that we can call, so we'd</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-comment">-- have to make the pattern match ourselves</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.RecSelId</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-string">&quot;Record selectors, use pattern matching&quot;</span><span>
</span><a name="line-184"></a><span>        </span><span class="hs-identifier hs-var">GHC.Var</span><span> </span><a name="local-6989586621679354100"><a href="#local-6989586621679354100"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>            </span><span class="hs-comment">-- Defined names, including builtin names</span><span>
</span><a name="line-186"></a><span>            </span><a name="local-6989586621679354101"><a href="#local-6989586621679354101"><span class="hs-identifier">maybeDef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PIR.lookupTerm</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.getName</span><span> </span><a href="#local-6989586621679354100"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679354101"><span class="hs-identifier hs-var">maybeDef</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-188"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679354102"><a href="#local-6989586621679354102"><span class="hs-identifier">term</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679354102"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-189"></a><span>                </span><span class="hs-comment">-- the term we get must be closed - we don't resolve most references</span><span>
</span><a name="line-190"></a><span>                </span><span class="hs-comment">-- TODO: possibly relax this?</span><span>
</span><a name="line-191"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#FreeVariableError"><span class="hs-identifier hs-var">FreeVariableError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Variable&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679354100"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">GHC.$+$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">GHC.idDetails</span><span> </span><a href="#local-6989586621679354100"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-identifier hs-var">GHC.Lit</span><span> </span><a name="local-6989586621679354103"><a href="#local-6989586621679354103"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convLiteral"><span class="hs-identifier hs-var">convLiteral</span></a><span> </span><a href="#local-6989586621679354103"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-193"></a><span>        </span><span class="hs-comment">-- arg can be a type here, in which case it's a type instantiation</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-identifier hs-var">GHC.App</span><span> </span><a name="local-6989586621679354104"><a href="#local-6989586621679354104"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Type</span><span> </span><a name="local-6989586621679354105"><a href="#local-6989586621679354105"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PIR.TyInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354104"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679354105"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-195"></a><span>        </span><span class="hs-comment">-- otherwise it's a normal application</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-identifier hs-var">GHC.App</span><span> </span><a name="local-6989586621679354106"><a href="#local-6989586621679354106"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679354107"><a href="#local-6989586621679354107"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PIR.Apply</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354106"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354107"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-197"></a><span>        </span><span class="hs-comment">-- if we're biding a type variable it's a type abstraction</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-identifier hs-var">GHC.Lam</span><span> </span><a name="local-6989586621679354108"><a href="#local-6989586621679354108"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.isTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679354109"><a href="#local-6989586621679354109"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Binders.html#mkTyAbsScoped"><span class="hs-identifier hs-var">mkTyAbsScoped</span></a><span> </span><a href="#local-6989586621679354108"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354109"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-199"></a><span>        </span><span class="hs-comment">-- othewise it's a normal lambda</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-identifier hs-var">GHC.Lam</span><span> </span><a name="local-6989586621679354110"><a href="#local-6989586621679354110"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679354111"><a href="#local-6989586621679354111"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Binders.html#mkLamAbsScoped"><span class="hs-identifier hs-var">mkLamAbsScoped</span></a><span> </span><a href="#local-6989586621679354110"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354111"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-201"></a><span>        </span><span class="hs-identifier hs-var">GHC.Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.NonRec</span><span> </span><a name="local-6989586621679354112"><a href="#local-6989586621679354112"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679354113"><a href="#local-6989586621679354113"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679354114"><a href="#local-6989586621679354114"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-comment">-- the binding is in scope for the body, but not for the arg</span><span>
</span><a name="line-203"></a><span>            </span><a name="local-6989586621679354115"><a href="#local-6989586621679354115"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354113"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-204"></a><span>            </span><a href="Language.PlutusTx.Compiler.Binders.html#withVarScoped"><span class="hs-identifier hs-var">withVarScoped</span></a><span> </span><a href="#local-6989586621679354112"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679354116"><a href="#local-6989586621679354116"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-205"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354117"><a href="#local-6989586621679354117"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">PIR.TermBind</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354116"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679354115"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-206"></a><span>                </span><a name="local-6989586621679354118"><a href="#local-6989586621679354118"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354114"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-207"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Let</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">PIR.NonRec</span><span> </span><a href="#local-6989586621679354117"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621679354118"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-208"></a><span>        </span><span class="hs-identifier hs-var">GHC.Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.Rec</span><span> </span><a name="local-6989586621679354119"><a href="#local-6989586621679354119"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679354120"><a href="#local-6989586621679354120"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-209"></a><span>            </span><a href="Language.PlutusTx.Compiler.Binders.html#withVarsScoped"><span class="hs-identifier hs-var">withVarsScoped</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679354119"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679354121"><a href="#local-6989586621679354121"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>                </span><span class="hs-comment">-- the bindings are scope in both the body and the args</span><span>
</span><a name="line-211"></a><span>                </span><span class="hs-comment">-- TODO: this is a bit inelegant matching the vars back up</span><span>
</span><a name="line-212"></a><span>                </span><a name="local-6989586621679354125"><a href="#local-6989586621679354125"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679354121"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621679354119"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679354122"><a href="#local-6989586621679354122"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679354123"><a href="#local-6989586621679354123"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-213"></a><span>                    </span><a name="local-6989586621679354124"><a href="#local-6989586621679354124"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354123"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-214"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.TermBind</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354122"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679354124"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-215"></a><span>                </span><a name="local-6989586621679354126"><a href="#local-6989586621679354126"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354120"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-216"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Let</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">PIR.Rec</span><span> </span><a href="#local-6989586621679354125"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621679354126"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-217"></a><span>        </span><span class="hs-identifier hs-var">GHC.Case</span><span> </span><a name="local-6989586621679354127"><a href="#local-6989586621679354127"><span class="hs-identifier">scrutinee</span></a></a><span> </span><a name="local-6989586621679354128"><a href="#local-6989586621679354128"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679354129"><a href="#local-6989586621679354129"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679354130"><a href="#local-6989586621679354130"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>            </span><span class="hs-comment">-- See Note [At patterns]</span><span>
</span><a name="line-219"></a><span>            </span><a name="local-6989586621679354131"><a href="#local-6989586621679354131"><span class="hs-identifier">scrutinee'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354127"><span class="hs-identifier hs-var">scrutinee</span></a><span>
</span><a name="line-220"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354132"><a href="#local-6989586621679354132"><span class="hs-identifier">scrutineeType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">GHC.varType</span><span> </span><a href="#local-6989586621679354128"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>            </span><span class="hs-comment">-- the variable for the scrutinee is bound inside the cases, but not in the scrutinee expression itself</span><span>
</span><a name="line-223"></a><span>            </span><a href="Language.PlutusTx.Compiler.Binders.html#withVarScoped"><span class="hs-identifier hs-var">withVarScoped</span></a><span> </span><a href="#local-6989586621679354128"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679354133"><a href="#local-6989586621679354133"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-224"></a><span>                </span><span class="hs-comment">-- See Note [Case expressions and laziness]</span><span>
</span><a name="line-225"></a><span>                </span><a name="local-6989586621679354136"><a href="#local-6989586621679354136"><span class="hs-identifier">isValueAlt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621679354130"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679354134"><a href="#local-6989586621679354134"><span class="hs-identifier">vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679354135"><a href="#local-6989586621679354135"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679354134"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">PIR.isTermValue</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354135"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354137"><a href="#local-6989586621679354137"><span class="hs-identifier">lazyCase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">and</span><span> </span><a href="#local-6989586621679354136"><span class="hs-identifier hs-var">isValueAlt</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>                </span><a name="local-6989586621679354138"><a href="#local-6989586621679354138"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getMatchInstantiated"><span class="hs-identifier hs-var">getMatchInstantiated</span></a><span> </span><a href="#local-6989586621679354132"><span class="hs-identifier hs-var">scrutineeType</span></a><span>
</span><a name="line-229"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354139"><a href="#local-6989586621679354139"><span class="hs-identifier">matched</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.Apply</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354138"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621679354131"><span class="hs-identifier hs-var">scrutinee'</span></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>                </span><span class="hs-comment">-- See Note [Scott encoding of datatypes]</span><span>
</span><a name="line-232"></a><span>                </span><span class="hs-comment">-- we're going to delay the body, so the scrutinee needs to be instantiated the delayed type</span><span>
</span><a name="line-233"></a><span>                </span><a name="local-6989586621679354140"><a href="#local-6989586621679354140"><span class="hs-identifier">instantiated</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">PIR.TyInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354139"><span class="hs-identifier hs-var">matched</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679354129"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Language.PlutusTx.Compiler.Laziness.html#maybeDelayType"><span class="hs-identifier hs-var">maybeDelayType</span></a><span> </span><a href="#local-6989586621679354137"><span class="hs-identifier hs-var">lazyCase</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679354143"><a href="#local-6989586621679354143"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679354144"><a href="#local-6989586621679354144"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">GHC.splitTyConApp_maybe</span><span> </span><a href="#local-6989586621679354132"><span class="hs-identifier hs-var">scrutineeType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-236"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679354141"><a href="#local-6989586621679354141"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679354142"><a href="#local-6989586621679354142"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679354141"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679354142"><span class="hs-identifier hs-var">argTys</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Scrutinee's type was not a type constructor application&quot;</span><span>
</span><a name="line-238"></a><span>                </span><a name="local-6989586621679354145"><a href="#local-6989586621679354145"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getDataCons"><span class="hs-identifier hs-var">getDataCons</span></a><span> </span><a href="#local-6989586621679354143"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>                </span><a name="local-6989586621679354149"><a href="#local-6989586621679354149"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621679354145"><span class="hs-identifier hs-var">dcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679354146"><a href="#local-6989586621679354146"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">GHC.findAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GHC.DataAlt</span><span> </span><a href="#local-6989586621679354146"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354130"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679354147"><a href="#local-6989586621679354147"><span class="hs-identifier">alt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-242"></a><span>                        </span><span class="hs-keyword">let</span><span>
</span><a name="line-243"></a><span>                            </span><span class="hs-comment">-- these are the instantiated type arguments, e.g. for the data constructor Just when</span><span>
</span><a name="line-244"></a><span>                            </span><span class="hs-comment">-- matching on Maybe Int it is [Int] (crucially, not [a])</span><span>
</span><a name="line-245"></a><span>                            </span><a name="local-6989586621679354148"><a href="#local-6989586621679354148"><span class="hs-identifier">instArgTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GHC.dataConInstOrigArgTys</span><span> </span><a href="#local-6989586621679354146"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621679354144"><span class="hs-identifier hs-var">argTys</span></a><span>
</span><a name="line-246"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convAlt"><span class="hs-identifier hs-var">convAlt</span></a><span> </span><a href="#local-6989586621679354137"><span class="hs-identifier hs-var">lazyCase</span></a><span> </span><a href="#local-6989586621679354148"><span class="hs-identifier hs-var">instArgTys</span></a><span> </span><a href="#local-6989586621679354147"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-247"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;No case matched and no default case&quot;</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354150"><a href="#local-6989586621679354150"><span class="hs-identifier">applied</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.mkIterApp</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354140"><span class="hs-identifier hs-var">instantiated</span></a><span> </span><a href="#local-6989586621679354149"><span class="hs-identifier hs-var">branches</span></a><span>
</span><a name="line-250"></a><span>                </span><span class="hs-comment">-- See Note [Case expressions and laziness]</span><span>
</span><a name="line-251"></a><span>                </span><a name="local-6989586621679354151"><a href="#local-6989586621679354151"><span class="hs-identifier">mainCase</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Laziness.html#maybeForce"><span class="hs-identifier hs-var">maybeForce</span></a><span> </span><a href="#local-6989586621679354137"><span class="hs-identifier hs-var">lazyCase</span></a><span> </span><a href="#local-6989586621679354150"><span class="hs-identifier hs-var">applied</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>                </span><span class="hs-comment">-- See Note [At patterns]</span><span>
</span><a name="line-254"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354152"><a href="#local-6989586621679354152"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">PIR.TermBind</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354133"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679354131"><span class="hs-identifier hs-var">scrutinee'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-255"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Let</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">PIR.NonRec</span><span> </span><a href="#local-6989586621679354152"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621679354151"><span class="hs-identifier hs-var">mainCase</span></a><span>
</span><a name="line-256"></a><span>        </span><span class="hs-comment">-- we can use source notes to get a better context for the inner expression</span><span>
</span><a name="line-257"></a><span>        </span><span class="hs-comment">-- these are put in when you compile with -g</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-identifier hs-var">GHC.Tick</span><span> </span><span class="hs-identifier hs-var">GHC.SourceNote</span><span class="hs-special">{</span><span class="hs-identifier">GHC.sourceSpan</span><span class="hs-glyph">=</span><a name="local-6989586621679354153"><a href="#local-6989586621679354153"><span class="hs-identifier">src</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679354154"><a href="#local-6989586621679354154"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-259"></a><span>            </span><a href="Language.PlutusTx.Compiler.Error.html#withContextM"><span class="hs-identifier hs-var">withContextM</span></a><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Utils.html#sdToTxt"><span class="hs-identifier hs-var">sdToTxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Converting expr at:&quot;</span><span> </span><span class="hs-operator hs-var">GHC.&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679354153"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354154"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-260"></a><span>        </span><span class="hs-comment">-- ignore other annotations</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier hs-var">GHC.Tick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679354155"><a href="#local-6989586621679354155"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354155"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-262"></a><span>        </span><span class="hs-identifier hs-var">GHC.Cast</span><span> </span><a name="local-6989586621679354156"><a href="#local-6989586621679354156"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679354157"><a href="#local-6989586621679354157"><span class="hs-identifier">coerce</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-263"></a><span>            </span><a name="local-6989586621679354158"><a href="#local-6989586621679354158"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354156"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-264"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#splitNewtypeCoercion"><span class="hs-identifier hs-var">splitNewtypeCoercion</span></a><span> </span><a href="#local-6989586621679354157"><span class="hs-identifier hs-var">coerce</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-265"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a><span> </span><a name="local-6989586621679354159"><a href="#local-6989586621679354159"><span class="hs-identifier">outer</span></a></a><span> </span><a name="local-6989586621679354160"><a href="#local-6989586621679354160"><span class="hs-identifier">inner</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-266"></a><span>                    </span><a name="local-6989586621679354161"><a href="#local-6989586621679354161"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getMatchInstantiated"><span class="hs-identifier hs-var">getMatchInstantiated</span></a><span> </span><a href="#local-6989586621679354159"><span class="hs-identifier hs-var">outer</span></a><span>
</span><a name="line-267"></a><span>                    </span><span class="hs-comment">-- unwrap by doing a &quot;trivial match&quot; - instantiate to the inner type and apply the identity</span><span>
</span><a name="line-268"></a><span>                    </span><a name="local-6989586621679354162"><a href="#local-6989586621679354162"><span class="hs-identifier">inner'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#convType"><span class="hs-identifier hs-var">convType</span></a><span> </span><a href="#local-6989586621679354160"><span class="hs-identifier hs-var">inner</span></a><span>
</span><a name="line-269"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354163"><a href="#local-6989586621679354163"><span class="hs-identifier">instantiated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.TyInst</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.Apply</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354161"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621679354158"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354162"><span class="hs-identifier hs-var">inner'</span></a><span>
</span><a name="line-270"></a><span>                    </span><a name="local-6989586621679354164"><a href="#local-6989586621679354164"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">safeFreshName</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;inner&quot;</span><span>
</span><a name="line-271"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679354165"><a href="#local-6989586621679354165"><span class="hs-identifier">identity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PIR.LamAbs</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354164"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679354162"><span class="hs-identifier hs-var">inner'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PIR.Var</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354164"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Apply</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354163"><span class="hs-identifier hs-var">instantiated</span></a><span> </span><a href="#local-6989586621679354165"><span class="hs-identifier hs-var">identity</span></a><span>
</span><a name="line-273"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Language.PlutusTx.Compiler.Type.html#Wrap"><span class="hs-identifier hs-var">Wrap</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679354166"><a href="#local-6989586621679354166"><span class="hs-identifier">outer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-274"></a><span>                    </span><a name="local-6989586621679354167"><a href="#local-6989586621679354167"><span class="hs-identifier">constr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Type.html#getConstructorsInstantiated"><span class="hs-identifier hs-var">getConstructorsInstantiated</span></a><span> </span><a href="#local-6989586621679354166"><span class="hs-identifier hs-var">outer</span></a><span>
</span><a name="line-275"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PIR.Apply</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679354167"><span class="hs-identifier hs-var">constr</span></a><span> </span><a href="#local-6989586621679354158"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-276"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Utils.html#throwSd"><span class="hs-identifier hs-var">throwSd</span></a><span> </span><a href="Language.PlutusTx.Compiler.Error.html#UnsupportedError"><span class="hs-identifier hs-var">UnsupportedError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Coercion&quot;</span><span> </span><span class="hs-operator hs-var">GHC.$+$</span><span> </span><span class="hs-identifier hs-var">GHC.ppr</span><span> </span><a href="#local-6989586621679354157"><span class="hs-identifier hs-var">coerce</span></a><span>
</span><a name="line-277"></a><span>        </span><span class="hs-identifier hs-var">GHC.Type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Cannot convert types directly, only as arguments to applications&quot;</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-identifier hs-var">GHC.Coercion</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#throwPlain"><span class="hs-identifier hs-var">throwPlain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Language.PlutusTx.Compiler.Error.html#ConversionError"><span class="hs-identifier hs-var">ConversionError</span></a><span> </span><span class="hs-string">&quot;Coercions should not be converted&quot;</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-identifier">convExprWithDefs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Language.PlutusTx.Compiler.Types.html#Converting"><span class="hs-identifier hs-type">Converting</span></a><span> </span><a href="#local-6989586621679353410"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GHC.CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679353410"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Language.PlutusTx.PIRTypes.html#PIRTerm"><span class="hs-identifier hs-type">PIRTerm</span></a><span>
</span><a name="line-281"></a><a name="convExprWithDefs"><a href="Language.PlutusTx.Compiler.Expr.html#convExprWithDefs"><span class="hs-identifier">convExprWithDefs</span></a></a><span> </span><a name="local-6989586621679354168"><a href="#local-6989586621679354168"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-282"></a><span>    </span><a href="Language.PlutusTx.Compiler.Builtins.html#defineBuiltinTypes"><span class="hs-identifier hs-var">defineBuiltinTypes</span></a><span>
</span><a name="line-283"></a><span>    </span><a href="Language.PlutusTx.Compiler.Builtins.html#defineBuiltinTerms"><span class="hs-identifier hs-var">defineBuiltinTerms</span></a><span>
</span><a name="line-284"></a><span>    </span><a href="Language.PlutusTx.Compiler.Expr.html#convExpr"><span class="hs-identifier hs-var">convExpr</span></a><span> </span><a href="#local-6989586621679354168"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-285"></a></pre></body></html>